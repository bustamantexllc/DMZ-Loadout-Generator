<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DMZ MW2 Loadout + Mission Generator</title>
  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1220;
      --text:#EAF1FF; --muted:#A9B7D6;
      --accent:#6BE4FF; --accent2:#9B7CFF;
      --border:rgba(255,255,255,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --danger:#FF5C7A;
      --ok:#52FFB5;
      --warn:#FFD166;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(155,124,255,.25), transparent 60%),
        radial-gradient(900px 700px at 100% 20%, rgba(107,228,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .wrap{
      width:min(1240px, 100%);
      display:grid;
      gap:18px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h1{margin:0; font-size:18px; letter-spacing:.5px}
    .title p{margin:0; color:var(--muted); font-size:13px; line-height:1.35}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 0 16px rgba(107,228,255,.4);
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .cardHeader h2{margin:0; font-size:14px; letter-spacing:.8px; color:var(--muted); text-transform:uppercase}
    .cardHeader .sub{margin-top:4px; color:rgba(234,241,255,.92); font-size:18px; font-weight:650}
    .sectionBody{padding:14px;}
    .grid2{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 560px){ .grid2{grid-template-columns:1fr} }

    .slot{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(14,26,46,.75), rgba(11,22,40,.75));
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .slot::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 160px at 10% 0%, rgba(107,228,255,.12), transparent 55%),
                  radial-gradient(520px 180px at 90% 10%, rgba(155,124,255,.12), transparent 55%);
      pointer-events:none;
    }
    .slotTop{display:flex; align-items:center; justify-content:space-between; gap:8px; position:relative;}
    .label{color:var(--muted); font-size:12px; letter-spacing:.5px; text-transform:uppercase;}
    .value{margin-top:6px; font-size:16px; font-weight:650; position:relative;}
    .attach{
      margin-top:10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top:8px;
      position:relative;
    }
    .attachTitle{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .attachList{
      margin-top:6px;
      display:grid;
      gap:4px;
    }
    .attachItem{
      font-size:12px;
      color:rgba(234,241,255,.92);
      line-height:1.25;
    }
    .attachItem span{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.35px;
      font-size:11px;
      margin-right:6px;
    }

    .controls{
      padding:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.12));
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      border:none;
      border-radius: 16px;
      padding:12px 14px;
      font-size:14px;
      font-weight:700;
      letter-spacing:.4px;
      cursor:pointer;
    }
    button.primary{
      color:#061018;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 40px rgba(107,228,255,.18);
    }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.12);
      font-weight:650;
    }
    button.danger{
      color:rgba(255,255,255,.95);
      background: rgba(255,92,122,.12);
      border:1px solid rgba(255,92,122,.35);
      font-weight:700;
    }
    button.ok{
      color:#061018;
      background: rgba(82,255,181,.85);
      border: 1px solid rgba(82,255,181,.35);
      box-shadow: 0 12px 40px rgba(82,255,181,.12);
      font-weight:800;
    }

    .side{display:flex; flex-direction:column; gap:18px;}
    .panel{padding:14px 14px 12px;}
    .panel h3{ margin:0 0 8px; font-size:14px; letter-spacing:.7px; text-transform:uppercase; color:var(--muted); }

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
    }
    .toggle .tL{display:flex; flex-direction:column; gap:4px;}
    .toggle .tL b{font-size:14px}
    .toggle .tL span{font-size:12px; color:var(--muted)}
    .switch{
      width:44px; height:26px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
      user-select:none;
    }
    .switch::after{
      content:"";
      width:20px; height:20px;
      border-radius:999px;
      position:absolute;
      top:50%; left:3px;
      transform:translateY(-50%);
      background: rgba(234,241,255,.86);
      transition: left .15s ease, background .15s ease;
    }
    .switch[data-on="true"]{ border-color: rgba(107,228,255,.35); background: rgba(107,228,255,.12); }
    .switch[data-on="true"]::after{ left:21px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }

    .sliderBox{
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
    }
    .sliderTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;}
    .sliderTop b{font-size:14px}
    .sliderTop span{font-size:12px; color:var(--muted)}
    input[type="range"]{width:100%}
    select{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(234,241,255,.92);
      padding:10px 12px;
      font-size:13px;
      font-weight:650;
    }
    .miniRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;}
    .mutedNote{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.4}
    .hidden{display:none !important;}

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10,16,28,.92);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(234,241,255,.95);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      font-size: 13px;
      z-index: 99;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}

    /* Mission UI update */
    .badgeRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:rgba(234,241,255,.92);
      white-space:nowrap;
    }
    .badge .bDot{width:8px;height:8px;border-radius:99px;background:rgba(107,228,255,.8);box-shadow:0 0 14px rgba(107,228,255,.25);}
    .badge.ok .bDot{background:rgba(82,255,181,.85);box-shadow:0 0 14px rgba(82,255,181,.22);}
    .badge.warn .bDot{background:rgba(255,209,102,.9);box-shadow:0 0 14px rgba(255,209,102,.22);}
    .badge.danger .bDot{background:rgba(255,92,122,.9);box-shadow:0 0 14px rgba(255,92,122,.22);}

    .missionCard{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding:12px;
      margin-bottom:10px;
    }
    .missionKey{font-size:12px; color:var(--muted); letter-spacing:.5px; text-transform:uppercase;}
    .missionVal{font-size:15px; font-weight:700; line-height:1.25; margin-top:6px;}
    .missionSmall{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35;}
    ul.objList{margin:10px 0 0; padding-left:18px; color:rgba(234,241,255,.92);}
    ul.objList li{margin:6px 0; font-size:13px; line-height:1.25;}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:10px 0;}
    .dailyCard{
      border:1px solid rgba(82,255,181,.18);
      background: rgba(82,255,181,.06);
    }

    /* Pools Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 100;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(1100px, 100%);
      max-height: 88svh;
      overflow:auto;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(18,28,48,.96), rgba(10,16,28,.96));
      box-shadow: var(--shadow);
    }
    .modalTop{
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(18,28,48,.98), rgba(18,28,48,.88));
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .modalTop h4{margin:0; font-size:14px; letter-spacing:.7px; text-transform:uppercase; color:var(--muted);}
    .modalTop .small{margin-top:6px; color:rgba(234,241,255,.90); font-size:13px; line-height:1.35;}
    .modalBody{padding:14px 16px;}
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:900px){ .modalGrid{grid-template-columns:1fr} }
    .poolBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .poolBox h5{margin:0 0 6px; font-size:13px; letter-spacing:.5px; text-transform:uppercase; color:rgba(234,241,255,.92);}
    .poolBox .hint{margin:0 0 10px; font-size:12px; color:var(--muted); line-height:1.35;}
    textarea{
      width:100%;
      min-height: 170px;
      resize:vertical;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(234,241,255,.92);
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.4;
    }
    .modalActions{
      position:sticky; bottom:0;
      background: linear-gradient(180deg, rgba(10,16,28,.30), rgba(10,16,28,.92));
      border-top:1px solid rgba(255,255,255,.10);
      padding:12px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(234,241,255,.9);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:3px 7px;
      border-radius: 10px;
      margin-left: 6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div>
      <div class="brand">
        <div class="title">
          <h1>DMZ MW2 Loadout + Mission Generator</h1>
          <p>DMZ-authentic missions • Faction flavor • Chains • Meme↔Meta • Daily Run</p>
        </div>
        <div class="pill"><span class="dot"></span><span id="seedLabel">Seed: —</span></div>
      </div>

      <!-- DAILY RUN CARD -->
      <div class="card" id="dailyCard" style="margin-top:14px;">
        <div class="cardHeader">
          <div>
            <h2>Daily Run Card</h2>
            <div class="sub" id="dailyHeadline">Not generated today</div>
            <div class="badgeRow" id="dailyBadges"></div>
          </div>
          <div class="pill" id="dailyResetPill">Resets: —</div>
        </div>
        <div class="sectionBody" id="dailyBody"></div>
        <div class="controls">
          <div class="btnRow">
            <button class="ok" id="dailyGenerateBtn">Generate Daily</button>
            <button class="secondary" id="dailyCopyBtn">Copy Daily</button>
            <button class="danger" id="dailyClearBtn">Clear</button>
          </div>
          <div class="mutedNote">Daily Run is locked for the day (saved in your browser). It uses your current settings.</div>
        </div>
      </div>

      <!-- LOADOUT -->
      <div class="card" style="margin-top:14px;">
        <div class="cardHeader">
          <div>
            <h2>Loadout</h2>
            <div class="sub" id="loadoutHeadline">Tap ROLL to generate</div>
          </div>
          <div class="pill" title="Primary is full pool. Secondary is limited to pistols/launchers/melee.">True secondary pool</div>
        </div>

        <div class="sectionBody">
          <div class="mutedNote" style="margin-bottom:10px;">
            <b>Regain</b> only adds extra gear slots. Missions unaffected by Regain.
          </div>

          <div class="grid2" id="baseLoadoutSlots"></div>

          <div id="extraGearWrap" class="hidden" style="margin-top:12px;">
            <div class="mutedNote" style="margin-bottom:10px;"><b>Extra Gear (Regain)</b></div>
            <div class="grid2" id="extraLoadoutSlots"></div>
          </div>
        </div>

        <div class="controls">
          <div class="btnRow">
            <button class="primary" id="rollBtn">ROLL LOADOUT</button>
            <button class="secondary" id="copyBtn">Copy</button>
            <button class="secondary" id="editPoolsBtn" title="Edit loadout pools (saved in your browser)">Edit Pools</button>
          </div>
          <div class="miniRow">
            <label class="mutedNote" style="margin:0;">Copy format</label>
            <select id="exportFormat">
              <option value="discord">Discord</option>
              <option value="plain" selected>Plain</option>
              <option value="checklist">Checklist</option>
              <option value="oneline">One-line</option>
            </select>
          </div>
        </div>
      </div>

      <!-- MISSION -->
      <div class="card" style="margin-top:14px;">
        <div class="cardHeader">
          <div>
            <h2>Mission Board</h2>
            <div class="sub" id="missionHeadline">Tap ROLL to generate</div>
            <div class="badgeRow" id="missionBadges"></div>
          </div>
          <div class="pill" id="modePill" title="Solo/Squad changes mission flavor">Mode: Solo</div>
        </div>

        <div class="sectionBody">
          <div class="mutedNote" id="factionBriefing" style="margin-bottom:10px;"></div>

          <div id="chainBlock" class="hidden" style="margin-bottom:12px;"></div>

          <div class="missionCard">
            <div class="missionKey">Mission Title</div>
            <div class="missionVal" id="missionTitle">—</div>
            <div class="missionSmall" id="missionSubtitle">—</div>
            <div class="divider"></div>
            <div class="missionKey">Objectives</div>
            <ul class="objList" id="missionObjectives"></ul>
            <div class="divider"></div>
            <div class="missionKey">Constraints</div>
            <ul class="objList" id="missionConstraints"></ul>
            <div class="divider"></div>
            <div class="missionKey">Optional Bonus</div>
            <div class="missionSmall" id="missionBonus">—</div>
          </div>
        </div>

        <div class="controls">
          <div class="btnRow">
            <button class="primary" id="rollMissionBtn">ROLL MISSION</button>
            <button class="secondary" id="startChainBtn">Start Chain</button>
            <button class="ok" id="advanceChainBtn">Advance Step</button>
            <button class="danger" id="failChainBtn">Fail / Reset</button>
          </div>
          <div class="mutedNote">Chains are multi-deployment objectives. If Chains are OFF, these buttons do nothing.</div>
        </div>
      </div>
    </div>

    <!-- SIDE -->
    <div class="side">
      <div class="card panel">
        <h3>Mission Difficulty</h3>
        <div class="sliderBox">
          <div class="sliderTop">
            <b id="diffLabel">Easy</b>
            <span id="diffHint">High completion</span>
          </div>
          <input id="diffSlider" type="range" min="0" max="2" step="1" value="0" />
        </div>
      </div>

      <div class="card panel">
        <h3>Meme ↔ Meta</h3>
        <div class="sliderBox">
          <div class="sliderTop">
            <b id="mmLabel">Balanced</b>
            <span id="mmHint">50%</span>
          </div>
          <input id="mmSlider" type="range" min="0" max="100" step="1" value="50" />
        </div>
        <div class="mutedNote">Affects loadout weighting + attachment coherence (not missions).</div>
      </div>

      <div class="card panel">
        <h3>Run Settings</h3>

        <div class="toggle">
          <div class="tL">
            <b>Regain Mode</b>
            <span>Adds Vest/Backpack/Revive/Mask slots only</span>
          </div>
          <div class="switch" id="regainSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="toggle" style="margin-top:10px;">
          <div class="tL">
            <b>Random Attachments</b>
            <span>Adds attachments to Primary/Secondary</span>
          </div>
          <div class="switch" id="attachSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="toggle" style="margin-top:10px;">
          <div class="tL">
            <b>Squad Missions</b>
            <span>Harder missions that require teammates</span>
          </div>
          <div class="switch" id="squadSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="toggle" style="margin-top:10px;">
          <div class="tL">
            <b>Mission Chains</b>
            <span>Multi-deployment transport/deliver missions</span>
          </div>
          <div class="switch" id="chainsSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="miniRow">
          <label class="mutedNote" style="margin:0;">Map flavor</label>
          <select id="mapFlavor">
            <option value="any" selected>Any</option>
            <option value="al">Al Mazrah</option>
            <option value="ash">Ashika</option>
            <option value="von">Vondel</option>
          </select>
        </div>

        <div class="mutedNote" style="margin-top:10px;">
          Map flavor is wording-only (no detection).
        </div>
      </div>

      <div class="card panel">
        <h3>Share</h3>
        <div class="mutedNote" style="margin-top:0;">
          GitHub Pages link is your site link.<br>
          Example: <span style="color:rgba(234,241,255,.9)">https://USERNAME.github.io/REPO/</span>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- POOLS MODAL -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Edit Pools">
      <div class="modalTop">
        <div>
          <h4>Edit Pools</h4>
          <div class="small">
            One item per line • blanks ignored • duplicates removed • saved to your browser.<br>
            Close with <span class="kbd">Esc</span>
          </div>
        </div>
        <div class="btnRow">
          <button class="secondary" id="copyJsonBtn">Copy JSON</button>
          <button class="danger" id="resetBtn">Reset Defaults</button>
          <button class="secondary" id="closeBtn">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="modalGrid" id="modalGrid"></div>
      </div>

      <div class="modalActions">
        <div class="mutedNote" style="margin:0;">After saving, hit <b>ROLL</b> to see changes.</div>
        <div class="btnRow">
          <button class="primary" id="savePoolsBtn">Save Pools</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   STORAGE KEYS
========================= */
const STORAGE_KEY_POOLS = "dmz_mw2_pools_v7";
const STORAGE_KEY_APP   = "dmz_mw2_appstate_v3";
const STORAGE_KEY_DAILY = "dmz_mw2_daily_v1";

/* =========================
   FACTIONS (FLAVOR)
========================= */
const FACTIONS = [
  {
    name: "White Lotus",
    tone: "ok",
    intros: [
      "White Lotus has identified an opportunity. Execute with discipline.",
      "Maintain operational security. Keep it clean and extract.",
      "Precision matters. Minimize exposure and finish the task."
    ],
    verbs: { acquire:"Acquire", secure:"Secure", upload:"Upload", deliver:"Deliver", exfil:"Exfil", clear:"Clear" }
  },
  {
    name: "Legion",
    tone: "warn",
    intros: [
      "Legion wants the area controlled. Expect resistance.",
      "Force projection required. Move decisively and secure the objective.",
      "No hesitation. Clear the route and extract with intent."
    ],
    verbs: { acquire:"Take", secure:"Hold", upload:"Transmit", deliver:"Move", exfil:"Extract", clear:"Clear" }
  },
  {
    name: "Black Mous",
    tone: "warn",
    intros: [
      "Black Mous needs a delivery handled quietly. Keep it moving.",
      "Loose ends are unacceptable. Deliver the asset and disappear.",
      "Smuggling run. Don’t get greedy—get it done."
    ],
    verbs: { acquire:"Acquire", secure:"Secure", upload:"Upload", deliver:"Dead drop", exfil:"Exfil", clear:"Breach" }
  },
  {
    name: "Crown",
    tone: "danger",
    intros: [
      "Crown demands results. High risk, high value.",
      "Failure is not acceptable. Operate like professionals.",
      "This is a premium operation. Execute and extract."
    ],
    verbs: { acquire:"Acquire", secure:"Secure", upload:"Confirm", deliver:"Deliver", exfil:"Exfiltrate", clear:"Clear" }
  }
];

/* =========================
   DEFAULT LOADOUT POOLS (MW2 DMZ)
========================= */
const DEFAULT_POOLS = {
  PRIMARY_WEAPONS: [
    "M4","TAQ-56","Kastov 762","Lachmann-556","STB 556","M16","Kastov-74u","Kastov 545",
    "M13B","Chimera","ISO Hemlock","Tempus Razorback","FR Avancer","M13C","TR-76 Geist",
    "Lachmann-762","SO-14","TAQ-V","FTAC Recon","Cronen Squall",
    "VEL 46","MX9","Lachmann Sub","Vaznev-9K","FSS Hurricane","Minibak","PDSW 528","Fennec 45","BAS-P",
    "ISO 45","Lachmann Shroud",
    "SAKIN MG38","HCR 56","556 Icarus","RAAL MG","RPK","RAPP H",
    "Lockwood 300","Expedite 12","Bryson 800","Bryson 890","KV Broadside","MX Guardian",
    "EBR-14","SP-R 208","Lockwood MK2","LM-S","SA-B 50","TAQ-M","Crossbow","Tempus Torrent",
    "MCPR-300","Signal 50","LA-B 330","SP-X 80","Victus XMR","FJX Imperium","Carrack .300"
  ],
  SECONDARY_WEAPONS: [
    "P890",".50 GS","X12","Basilisk","X13 Auto","FTac Siege","GS Magna","9mm Daemon",
    "RPG-7","PILA","JOKR","Strela-P",
    "Riot Shield","Combat Knife","Dual Kodachis","Tonfa","Pickaxe","Dual Kamas"
  ],
  TACTICAL: [
    "Flash Grenade","Stun Grenade","Smoke Grenade","Snapshot Grenade","Tear Gas",
    "Stim","Decoy Grenade","Heartbeat Sensor","Shock Stick","Spotter Scope"
  ],
  LETHAL: [
    "Frag Grenade","Semtex","Drill Charge","Molotov Cocktail","Throwing Knife",
    "Proximity Mine","Thermite","C4","Claymore"
  ],
  FIELD_UPGRADE: [
    "Munitions Box","Armor Box","Trophy System","Dead Silence","Recon Drone"
  ],
  VEST: [
    "2-Plate Vest","3-Plate Vest","3-Plate Comms Vest","3-Plate Medic Vest","3-Plate Stealth Vest"
  ],
  BACKPACK: ["Small Backpack","Medium Backpack","Large Backpack"],
  REVIVE: ["Self-Revive Kit","Revive Pistol"],
  MASK: ["Gas Mask","Durable Gas Mask","Radiation Blocker"]
};

const META_PRIMARY = new Set(["TAQ-56","ISO Hemlock","M13B","Chimera","M4","Vaznev-9K","Lachmann Sub","Fennec 45","BAS-P","RPK","RAAL MG","Cronen Squall","TAQ-V","MCPR-300","Victus XMR","Signal 50"]);
const MEME_PRIMARY = new Set(["Crossbow","Lockwood MK2","SP-R 208","LM-S","Lockwood 300","Bryson 800","Bryson 890","KV Broadside","M16","SO-14","FTAC Recon","Minibak","MX9","Carrack .300","LA-B 330"]);

/* =========================
   ATTACHMENTS
========================= */
const WEAPON_TYPE = {
  SHOTGUN: new Set(["Lockwood 300","Expedite 12","Bryson 800","Bryson 890","KV Broadside","MX Guardian"]),
  PISTOL: new Set(["P890",".50 GS","X12","Basilisk","X13 Auto","FTac Siege","GS Magna","9mm Daemon"]),
  LAUNCHER: new Set(["RPG-7","PILA","JOKR","Strela-P"]),
  MELEE: new Set(["Riot Shield","Combat Knife","Dual Kodachis","Tonfa","Pickaxe","Dual Kamas"]),
  SPECIAL: new Set(["Crossbow"])
};

const ATTACH_POOLS = {
  OPTIC: ["Cronen Mini Pro","Slimline Pro","VLK 4.0 Optic","Aim OP-V4","SZ Holotherm","Cronen C480 Pro Optic","Xten Angel-40","DF105 Reflex Sight","Thermo-Optic X9"],
  MUZZLE: ["Sakin Tread-40","Echoless-80","Harbinger D20","Lockshot KT85","Komodo Heavy","XTEN Ported 290","RF Crown 50"],
  BARREL: ["Long Barrel","Heavy Barrel","Short Barrel","Precision Barrel","Rifle-Length Barrel","XRK Barrel","FTAC Barrel","Hightower Barrel"],
  UNDERBARREL: ["FSS Sharkfin 90","Edge-47 Grip","Commando Foregrip","FTAC Ripper 56","VX Pineapple"],
  MAGAZINE: ["Extended Mag","High Capacity Mag","Fast Mag","Drum Mag (if available)"],
  LASER: ["FSS OLE-V Laser","VLK LZR 7mW","1mW Quick Fire Laser","Hipfire Laser"],
  STOCK: ["Heavy Stock","Light Stock","No Stock","Tactical Stock","Precision Stock"],
  REAR_GRIP: ["Granular Grip","Stippled Grip Tape","Rubberized Grip Tape","Ergonomic Grip","Recoil Grip"],
  AMMO: ["High Velocity","Armor Piercing","Incendiary","Frangible"],
  BOLT: ["Fast Bolt","Heavy Bolt"],
  GUARD: ["Guard: Tactical","Guard: Heavy","Guard: Lightweight"],
  TRIGGER: ["Hair Trigger","Match Trigger","Quickdraw Trigger"]
};

const ATTACH_SLOTS_BY_TYPE = {
  RIFLE: ["OPTIC","MUZZLE","BARREL","UNDERBARREL","MAGAZINE","LASER","STOCK","REAR_GRIP","AMMO"],
  SHOTGUN: ["OPTIC","MUZZLE","BARREL","UNDERBARREL","MAGAZINE","LASER","STOCK","GUARD","AMMO"],
  PISTOL: ["OPTIC","MUZZLE","BARREL","MAGAZINE","LASER","REAR_GRIP","AMMO","TRIGGER"],
  SPECIAL: ["OPTIC","UNDERBARREL","AMMO","BOLT"],
  LAUNCHER: [],
  MELEE: []
};

const ATTACH_PRESETS = {
  STEALTH: ["MUZZLE","BARREL","UNDERBARREL","OPTIC","MAGAZINE"],
  RECOIL: ["MUZZLE","UNDERBARREL","STOCK","REAR_GRIP","OPTIC"],
  ADS: ["LASER","STOCK","REAR_GRIP","BARREL","OPTIC"],
  RANGE: ["MUZZLE","BARREL","OPTIC","UNDERBARREL","AMMO"]
};

function niceSlotName(slotKey){
  return ({OPTIC:"Optic",MUZZLE:"Muzzle",BARREL:"Barrel",UNDERBARREL:"Underbarrel",MAGAZINE:"Magazine",LASER:"Laser",STOCK:"Stock",REAR_GRIP:"Rear Grip",AMMO:"Ammunition",BOLT:"Bolt",GUARD:"Guard",TRIGGER:"Trigger"})[slotKey] || slotKey;
}

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function getWeaponType(weaponName){
  if(WEAPON_TYPE.LAUNCHER.has(weaponName)) return "LAUNCHER";
  if(WEAPON_TYPE.MELEE.has(weaponName)) return "MELEE";
  if(WEAPON_TYPE.SHOTGUN.has(weaponName)) return "SHOTGUN";
  if(WEAPON_TYPE.PISTOL.has(weaponName)) return "PISTOL";
  if(WEAPON_TYPE.SPECIAL.has(weaponName)) return "SPECIAL";
  return "RIFLE";
}

function rollAttachmentsForWeapon(weaponName, metaScore01){
  const type = getWeaponType(weaponName);
  const slots = ATTACH_SLOTS_BY_TYPE[type] || [];
  if(!slots.length) return [];

  const isMeta = metaScore01 >= 0.67;
  const isMeme = metaScore01 <= 0.33;

  let chosenSlots = [];
  if(isMeta){
    const preset = pick(Object.keys(ATTACH_PRESETS));
    chosenSlots = ATTACH_PRESETS[preset].filter(s => slots.includes(s)).slice(0,5);
  }else if(isMeme){
    const shuffled = slots.slice().sort(()=>Math.random()-0.5);
    chosenSlots = shuffled.slice(0, Math.min(5, shuffled.length));
  }else{
    const shuffled = slots.slice().sort(()=>Math.random()-0.5);
    chosenSlots = shuffled.slice(0, Math.min(5, shuffled.length));
  }

  const att = [];
  for(const slotKey of chosenSlots){
    const pool = ATTACH_POOLS[slotKey] || [];
    if(!pool.length) continue;
    att.push({ slot: slotKey, name: pick(pool) });
  }
  return att;
}

/* =========================
   MAP FLAVOR
========================= */
const MAPS = {
  any: { name:"Any", pois:["a major POI","a quiet district","a fortified area","a riverside sector"] },
  al:  { name:"Al Mazrah", pois:["Al Mazrah City","Rohan Oil","Al Sharim Pass","Sattiq Caves","Zaya Observatory","Sawah Village","Hydroelectric"] },
  ash: { name:"Ashika", pois:["Tsuki Castle","Port Ashika","Residential","Beach Club","Shipwreck","Town Center"] },
  von: { name:"Vondel", pois:["Central Station","Market","Castle","University","Police Station","Zoo","Stadium"] }
};

/* =========================
   DMZ-AUTHENTIC MISSION TEMPLATES
========================= */
const CONTRACTS = ["HVT","Secure Intel","Hostage Rescue","Raid Weapon Stash"];
const SYSTEMS = {
  deadDrops: ["a dead drop","a dumpster dead drop","a police station dead drop"],
  stronghold: "a Stronghold",
  uav: "a UAV Tower",
  buy: "a Buy Station",
  locked: "a locked space"
};

function randSeed(){ return Math.random().toString(36).slice(2, 8).toUpperCase(); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function difficultyKey(){ return state.difficulty === 0 ? "easy" : (state.difficulty === 1 ? "normal" : "spicy"); }

function chooseFaction(){
  const diff = difficultyKey();
  const pool = [];
  for(const f of FACTIONS){
    let w = 1;
    if(f.name === "Crown") w = (diff === "spicy" ? 3 : (diff === "normal" ? 2 : 1));
    if(f.name === "Black Mous") w = (diff === "normal" ? 2 : 1);
    for(let i=0;i<w;i++) pool.push(f);
  }
  return pick(pool);
}

function missionTemplate_ContractRun(faction, map, mode){
  const c1 = pick(CONTRACTS);
  const c2 = pick(CONTRACTS.filter(x=>x!==c1));
  const poi = pick(map.pois);
  const obj = [];

  if(difficultyKey() === "easy"){
    obj.push(`${faction.verbs.secure} a ${c1} contract and complete it.`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else if(difficultyKey() === "normal"){
    obj.push(`${faction.verbs.secure} a ${c1} contract and complete it (same deployment).`);
    obj.push(`${faction.verbs.secure} a second contract (${c2}) and complete it (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else{
    obj.push(`${faction.verbs.secure} a ${c1} contract at ${poi} and complete it (same deployment).`);
    obj.push(`${faction.verbs.secure} a second contract (${c2}) and complete it (same deployment).`);
    obj.push(`${faction.verbs.secure} ${SYSTEMS.stronghold} and clear it (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }

  const constraints = [];
  if(mode === "squad") constraints.push("All squad members must exfil on the same helicopter.");
  constraints.push("Avoid unnecessary PvP—fight only when required.");
  if(difficultyKey() !== "easy") constraints.push(`No ${SYSTEMS.uav}.`);

  const bonus = (difficultyKey()==="spicy") ? "Final exfil only (if safe)." : "Exfil at the first available helicopter.";

  return {
    title: (mode==="squad" ? "Coordinated Contract Sweep" : "Contract Sweep"),
    subtitle: `Faction: ${faction.name} • Focus: contracts • Map: ${map.name}`,
    objectives: obj,
    constraints,
    bonus
  };
}

function missionTemplate_DeadDropLogistics(faction, map, mode){
  const dd = pick(SYSTEMS.deadDrops);
  const poi = pick(map.pois);
  const obj = [];
  if(difficultyKey()==="easy"){
    obj.push(`${faction.verbs.acquire} a valuable item.`);
    obj.push(`${faction.verbs.deliver} it into ${dd}.`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else if(difficultyKey()==="normal"){
    obj.push(`${faction.verbs.acquire} an item and ${faction.verbs.deliver} it into ${dd} (same deployment).`);
    obj.push(`${faction.verbs.secure} a contract phone and complete any contract (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else{
    obj.push(`${faction.verbs.acquire} two valuables and ${faction.verbs.deliver} both into ${dd} (same deployment).`);
    obj.push(`${faction.verbs.secure} ${SYSTEMS.locked} at ${poi} and loot it (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully with $40,000+ cash/value.`);
  }

  const constraints = [];
  constraints.push(`No ${SYSTEMS.buy}.`);
  if(mode==="squad") constraints.push("One teammate carries valuables while another provides overwatch.");
  if(difficultyKey()==="spicy") constraints.push("No vehicles.");

  const bonus = "Extract without any teammate going down (or reset).";

  return {
    title: "Black Market Logistics",
    subtitle: `Faction: ${faction.name} • Focus: dead drops • Map: ${map.name}`,
    objectives: obj,
    constraints,
    bonus
  };
}

function missionTemplate_IntelOps(faction, map, mode){
  const poi = pick(map.pois);
  const obj = [];
  if(difficultyKey()==="easy"){
    obj.push(`${faction.verbs.acquire} an intel item (notes/document).`);
    obj.push(`${faction.verbs.exfil} with the intel.`);
  }else if(difficultyKey()==="normal"){
    obj.push(`${faction.verbs.secure} a Secure Intel contract and complete the upload (same deployment).`);
    obj.push(`${faction.verbs.acquire} any intel item and ${faction.verbs.exfil} with it (same deployment).`);
  }else{
    obj.push(`${faction.verbs.secure} a Secure Intel contract at ${poi} and complete the upload (same deployment).`);
    obj.push(`${faction.verbs.secure} ${SYSTEMS.stronghold} and clear it (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully on final exfil (if safe).`);
  }

  const constraints = [];
  constraints.push("Avoid PvP unless fired upon.");
  if(mode==="squad") constraints.push("Stay within 50m of a teammate during the upload.");
  if(difficultyKey()!=="easy") constraints.push(`No ${SYSTEMS.uav}.`);

  const bonus = "No field upgrades used during the mission.";

  return {
    title: "Verified Intel",
    subtitle: `Faction: ${faction.name} • Focus: intel • Map: ${map.name}`,
    objectives: obj,
    constraints,
    bonus
  };
}

function missionTemplate_StrongholdPressure(faction, map, mode){
  const poi = pick(map.pois);
  const obj = [];
  if(difficultyKey()==="easy"){
    obj.push(`${faction.verbs.clear} ${SYSTEMS.stronghold}.`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else if(difficultyKey()==="normal"){
    obj.push(`${faction.verbs.clear} ${SYSTEMS.stronghold} and loot it (same deployment).`);
    obj.push(`${faction.verbs.secure} any contract and complete it (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else{
    obj.push(`${faction.verbs.clear} two Strongholds (same deployment).`);
    obj.push(`${faction.verbs.secure} a ${pick(CONTRACTS)} contract at ${poi} and complete it (same deployment).`);
    obj.push(`${faction.verbs.exfil} on final exfil (if safe).`);
  }

  const constraints = [];
  constraints.push(`No ${SYSTEMS.buy}.`);
  if(mode==="squad") constraints.push("Each teammate must enter the Stronghold at least once during the clear.");
  if(difficultyKey()==="spicy") constraints.push("One-weapon rule: only use your Primary weapon.");

  const bonus = "Extract with full plates.";

  return {
    title: "Breach & Clear",
    subtitle: `Faction: ${faction.name} • Focus: strongholds • Map: ${map.name}`,
    objectives: obj,
    constraints,
    bonus
  };
}

function missionTemplate_HighValueExtraction(faction, map, mode){
  const obj = [];
  if(difficultyKey()==="easy"){
    obj.push(`${faction.verbs.acquire} $20,000+ cash/value.`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else if(difficultyKey()==="normal"){
    obj.push(`${faction.verbs.acquire} $30,000+ cash/value (same deployment).`);
    obj.push(`${faction.verbs.secure} any contract and complete it (same deployment).`);
    obj.push(`${faction.verbs.exfil} successfully.`);
  }else{
    obj.push(`${faction.verbs.acquire} $40,000+ cash/value (same deployment).`);
    obj.push(`${faction.verbs.secure} ${SYSTEMS.locked} and loot it (same deployment).`);
    obj.push(`${faction.verbs.exfil} on final exfil (if safe).`);
  }

  const constraints = [];
  constraints.push(`No ${SYSTEMS.uav}.`);
  if(difficultyKey()!=="easy") constraints.push(`No ${SYSTEMS.buy}.`);
  if(mode==="squad") constraints.push("Total value is combined across the squad at exfil.");

  const bonus = "Extract 2 valuables in your backpack.";

  return {
    title: "High-Value Extraction",
    subtitle: `Faction: ${faction.name} • Focus: value • Map: ${map.name}`,
    objectives: obj,
    constraints,
    bonus
  };
}

function buildMission(){
  const map = MAPS[state.mapFlavor] || MAPS.any;
  const faction = state.factionObj;
  const mode = state.squad ? "squad" : "solo";

  const templates = [];
  const add = (fn, w)=>{ for(let i=0;i<w;i++) templates.push(fn); };

  if(faction.name==="White Lotus"){
    add(missionTemplate_IntelOps, 4);
    add(missionTemplate_ContractRun, 2);
    add(missionTemplate_StrongholdPressure, 1);
  }else if(faction.name==="Black Mous"){
    add(missionTemplate_DeadDropLogistics, 4);
    add(missionTemplate_ContractRun, 2);
    add(missionTemplate_HighValueExtraction, 1);
  }else if(faction.name==="Legion"){
    add(missionTemplate_StrongholdPressure, 3);
    add(missionTemplate_ContractRun, 3);
    add(missionTemplate_HighValueExtraction, 1);
  }else{
    add(missionTemplate_HighValueExtraction, 4);
    add(missionTemplate_ContractRun, 2);
    add(missionTemplate_StrongholdPressure, 1);
  }

  return pick(templates)(faction, map, mode);
}

/* =========================
   CHAINS
========================= */
const CHAINS = [
  {
    id: "bm_arms_courier",
    name: "Arms Courier",
    faction: "Black Mous",
    modes: ["solo","squad"],
    briefing: "Black Mous needs a weapon moved between zones. Don’t lose the asset.",
    steps: [
      { title:"Acquisition", objectives:["Extract with your current Primary weapon (the ‘asset’).","Do not swap Primary weapons before exfil."], constraints:["If you lose the Primary weapon, the step fails."], bonus:"Exfil first available helicopter." },
      { title:"Transport", objectives:["In a new deployment, infil with the same Primary weapon.","Extract again with the same Primary weapon."], constraints:["If the weapon is lost, the chain resets.","No UAV Towers."], bonus:"No Buy Stations." },
      { title:"Delivery", objectives:["Get 3 operator kills with the asset weapon (same deployment).","Exfil successfully."], constraints:["If you go down, disengage and re-plate before re-engaging."], bonus:"Final exfil only (if safe)." }
    ]
  },
  {
    id: "wl_verified_intel_chain",
    name: "Verified Intel",
    faction: "White Lotus",
    modes: ["solo","squad"],
    briefing: "White Lotus requires verified information from the field. Keep it clean.",
    steps: [
      { title:"Collection", objectives:["Acquire any intel item (notes/document).","Exfil with it."], constraints:["Avoid PvP unless fired upon."], bonus:"No field upgrades." },
      { title:"Verification", objectives:["In a new deployment, complete a Secure Intel contract.","Exfil successfully."], constraints:["No UAV Towers."], bonus:"No vehicles." },
      { title:"Extraction", objectives:["Complete any contract (same deployment).","Exfil on final exfil (if safe)."], constraints:["No Buy Stations."], bonus:"No downs." }
    ]
  }
];

/* =========================
   STATE
========================= */
const state = {
  seed: null,
  regain: false,
  attachments: false,
  squad: false,
  chains: false,
  difficulty: 0,
  mapFlavor: "any",
  memeMeta: 50,
  factionObj: null,
  activeChainId: null,
  activeChainStep: 0
};

/* =========================
   ELEMENTS
========================= */
const elSeed = document.getElementById("seedLabel");
const toast = document.getElementById("toast");

const elLoadoutHeadline = document.getElementById("loadoutHeadline");
const elMissionHeadline = document.getElementById("missionHeadline");

const elBaseSlots = document.getElementById("baseLoadoutSlots");
const elExtraWrap = document.getElementById("extraGearWrap");
const elExtraSlots = document.getElementById("extraLoadoutSlots");

const elMissionBadges = document.getElementById("missionBadges");
const elFactionBriefing = document.getElementById("factionBriefing");
const elChainBlock = document.getElementById("chainBlock");

const elMissionTitle = document.getElementById("missionTitle");
const elMissionSubtitle = document.getElementById("missionSubtitle");
const elMissionObjectives = document.getElementById("missionObjectives");
const elMissionConstraints = document.getElementById("missionConstraints");
const elMissionBonus = document.getElementById("missionBonus");

const diffSlider = document.getElementById("diffSlider");
const diffLabel = document.getElementById("diffLabel");
const diffHint = document.getElementById("diffHint");
const modePill = document.getElementById("modePill");

const mmSlider = document.getElementById("mmSlider");
const mmLabel = document.getElementById("mmLabel");
const mmHint = document.getElementById("mmHint");

const exportFormatEl = document.getElementById("exportFormat");
const mapFlavorEl = document.getElementById("mapFlavor");

const modalOverlay = document.getElementById("modalOverlay");
const modalGrid = document.getElementById("modalGrid");

const dailyCard = document.getElementById("dailyCard");
const dailyHeadline = document.getElementById("dailyHeadline");
const dailyBody = document.getElementById("dailyBody");
const dailyBadges = document.getElementById("dailyBadges");
const dailyResetPill = document.getElementById("dailyResetPill");

/* =========================
   UTILS
========================= */
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1200);
}
function setSwitch(el, on){
  el.dataset.on = on ? "true" : "false";
  el.setAttribute("aria-checked", on ? "true" : "false");
}
function nowLocalISODate(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function msUntilLocalMidnight(){
  const now = new Date();
  const next = new Date(now);
  next.setHours(24,0,0,0);
  return next.getTime() - now.getTime();
}
function fmtDuration(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  return `${h}h ${m}m`;
}
function metaScore01(){ return Math.max(0, Math.min(1, state.memeMeta/100)); }

/* =========================
   POOLS
========================= */
function normalizeList(text){
  return Array.from(new Set(String(text||"").split("\n").map(x=>x.trim()).filter(Boolean)));
}
function loadPools(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_POOLS);
    if(!raw) return structuredClone(DEFAULT_POOLS);
    const parsed = JSON.parse(raw);
    const merged = { ...structuredClone(DEFAULT_POOLS), ...parsed };
    for(const k of Object.keys(merged)){
      if(!Array.isArray(merged[k])) merged[k] = [];
      merged[k] = Array.from(new Set(merged[k].map(x=>String(x).trim()).filter(Boolean)));
    }
    return merged;
  }catch{
    return structuredClone(DEFAULT_POOLS);
  }
}
function savePools(pools){
  const safe = { ...structuredClone(DEFAULT_POOLS), ...pools };
  for(const k of Object.keys(safe)){
    if(!Array.isArray(safe[k])) safe[k] = [];
    safe[k] = Array.from(new Set(safe[k].map(x=>String(x).trim()).filter(Boolean)));
  }
  localStorage.setItem(STORAGE_KEY_POOLS, JSON.stringify(safe, null, 2));
}
function getPools(){ return loadPools(); }

/* =========================
   APP STATE
========================= */
function saveAppState(){
  try{
    localStorage.setItem(STORAGE_KEY_APP, JSON.stringify({
      regain: state.regain,
      attachments: state.attachments,
      squad: state.squad,
      chains: state.chains,
      difficulty: state.difficulty,
      mapFlavor: state.mapFlavor,
      memeMeta: state.memeMeta,
      activeChainId: state.activeChainId,
      activeChainStep: state.activeChainStep,
      exportFormat: exportFormatEl.value
    }));
  }catch{}
}
function loadAppState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_APP);
    if(!raw) return;
    const o = JSON.parse(raw);
    if(typeof o.regain==="boolean") state.regain=o.regain;
    if(typeof o.attachments==="boolean") state.attachments=o.attachments;
    if(typeof o.squad==="boolean") state.squad=o.squad;
    if(typeof o.chains==="boolean") state.chains=o.chains;
    if(Number.isFinite(o.difficulty)) state.difficulty=o.difficulty;
    if(typeof o.mapFlavor==="string") state.mapFlavor=o.mapFlavor;
    if(Number.isFinite(o.memeMeta)) state.memeMeta=o.memeMeta;
    if(typeof o.activeChainId==="string") state.activeChainId=o.activeChainId;
    if(Number.isFinite(o.activeChainStep)) state.activeChainStep=o.activeChainStep;
    if(typeof o.exportFormat==="string") exportFormatEl.value=o.exportFormat;
  }catch{}
}

/* =========================
   POOLS MODAL
========================= */
const POOL_FIELDS = [
  ["PRIMARY_WEAPONS","Primary Weapons (full pool)","Everything eligible for PRIMARY. One per line."],
  ["SECONDARY_WEAPONS","Secondary Weapons (limited)","Only items eligible for SECONDARY (handguns/launchers/melee). One per line."],
  ["TACTICAL","Tactical","One per line."],
  ["LETHAL","Lethal","One per line."],
  ["FIELD_UPGRADE","Field Upgrade","One per line."],
  ["VEST","Vest (Regain extra slot)","Only appears when Regain is ON."],
  ["BACKPACK","Backpack (Regain extra slot)","Only appears when Regain is ON."],
  ["REVIVE","Revive (Regain extra slot)","Only appears when Regain is ON."],
  ["MASK","Mask (Regain extra slot)","Only appears when Regain is ON."]
];
function openModal(){
  renderPoolsEditor();
  modalOverlay.classList.add("show");
  modalOverlay.setAttribute("aria-hidden","false");
}
function closeModal(){
  modalOverlay.classList.remove("show");
  modalOverlay.setAttribute("aria-hidden","true");
}
function renderPoolsEditor(){
  const pools = getPools();
  modalGrid.innerHTML = "";
  for(const [key,title,hint] of POOL_FIELDS){
    const box = document.createElement("div");
    box.className = "poolBox";
    box.innerHTML = `
      <h5>${escapeHtml(title)}</h5>
      <div class="hint">${escapeHtml(hint)}</div>
      <textarea id="ta_${key}" spellcheck="false"></textarea>
    `;
    modalGrid.appendChild(box);
    box.querySelector("textarea").value = (pools[key] ?? []).join("\n");
  }
}
function saveFromEditor(){
  const next = {};
  for(const [key] of POOL_FIELDS){
    const ta = document.getElementById("ta_" + key);
    next[key] = normalizeList(ta ? ta.value : "");
  }
  savePools(next);
  showToast("Pools saved");
}
async function copyPoolsJson(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_POOLS) || JSON.stringify(getPools(), null, 2);
    await navigator.clipboard.writeText(raw);
    showToast("Copied JSON");
  }catch{
    showToast("Copy failed");
  }
}
function resetPools(){
  localStorage.removeItem(STORAGE_KEY_POOLS);
  renderPoolsEditor();
  showToast("Defaults restored");
}

/* =========================
   UI HELPERS
========================= */
function updateDifficultyUI(){
  const labels = ["Easy","Normal","Spicy"];
  const hints = ["High completion","Balanced","More demanding"];
  diffLabel.textContent = labels[state.difficulty];
  diffHint.textContent = hints[state.difficulty];
  diffSlider.value = String(state.difficulty);
}
function updateMemeMetaUI(){
  mmSlider.value = String(state.memeMeta);
  mmHint.textContent = `${state.memeMeta}%`;
  if(state.memeMeta <= 33) mmLabel.textContent = "Meme";
  else if(state.memeMeta >= 67) mmLabel.textContent = "Meta";
  else mmLabel.textContent = "Balanced";
}

function renderBadges(faction){
  const diffTone = state.difficulty===2 ? "danger" : (state.difficulty===1 ? "warn" : "ok");
  const badges = [
    {text:`Faction: ${faction.name}`, tone:faction.tone},
    {text:`Difficulty: ${["Easy","Normal","Spicy"][state.difficulty]}`, tone:diffTone},
    {text:`Chains: ${state.chains ? "ON" : "OFF"}`, tone: state.chains ? "warn" : "ok"},
    {text:`Meme↔Meta: ${state.memeMeta}%`, tone: state.memeMeta<=33 ? "warn" : "ok"}
  ];
  elMissionBadges.innerHTML = badges.map(b=>`<span class="badge ${b.tone}"><span class="bDot"></span>${escapeHtml(b.text)}</span>`).join("");
}

function renderMission(m){
  elMissionTitle.textContent = m.title || "—";
  elMissionSubtitle.textContent = m.subtitle || "—";
  const obj = (m.objectives || []).slice(0, 10);
  elMissionObjectives.innerHTML = obj.length ? obj.map(x=>`<li>${escapeHtml(x)}</li>`).join("") : "<li>—</li>";
  const con = (m.constraints || []).slice(0, 10);
  elMissionConstraints.innerHTML = con.length ? con.map(x=>`<li>${escapeHtml(x)}</li>`).join("") : "<li>—</li>";
  elMissionBonus.textContent = m.bonus || "—";
}

/* =========================
   LOADOUT
========================= */
function weightedPickPrimary(primaryPool){
  const pMeta = metaScore01();
  const isMeta = Math.random() < pMeta;
  const metaCandidates = primaryPool.filter(w => META_PRIMARY.has(w));
  const memeCandidates = primaryPool.filter(w => MEME_PRIMARY.has(w));
  const other = primaryPool.filter(w => !META_PRIMARY.has(w) && !MEME_PRIMARY.has(w));

  if(isMeta){
    if(metaCandidates.length) return pick(metaCandidates);
    return pick(primaryPool);
  }else{
    if(memeCandidates.length) return pick(memeCandidates);
    if(other.length) return pick(other);
    return pick(primaryPool);
  }
}

function generateLoadout(pools){
  const primaryPool = pools.PRIMARY_WEAPONS ?? [];
  const secondaryPool = pools.SECONDARY_WEAPONS ?? [];

  const primary = primaryPool.length ? weightedPickPrimary(primaryPool) : "—";
  const secondary = secondaryPool.length ? pick(secondaryPool) : "—";

  const base = {
    Primary: primary,
    Secondary: secondary,
    Tactical: pick(pools.TACTICAL ?? []) || "—",
    Lethal: pick(pools.LETHAL ?? []) || "—",
    "Field Upgrade": pick(pools.FIELD_UPGRADE ?? []) || "—"
  };

  const extra = {};
  if(state.regain){
    extra.Vest = pick(pools.VEST ?? []) || "—";
    extra.Backpack = pick(pools.BACKPACK ?? []) || "—";
    extra.Revive = pick(pools.REVIVE ?? []) || "—";
    extra.Mask = pick(pools.MASK ?? []) || "—";
  }

  const attachments = {};
  if(state.attachments){
    const m = metaScore01();
    attachments.Primary = rollAttachmentsForWeapon(primary, m);
    attachments.Secondary = rollAttachmentsForWeapon(secondary, m);
  }

  return { base, extra, attachments };
}

function renderLoadout(loadout){
  const ORDER_BASE = ["Primary","Secondary","Tactical","Lethal","Field Upgrade"];
  const ORDER_EXTRA = ["Vest","Backpack","Revive","Mask"];

  elBaseSlots.innerHTML = ORDER_BASE.map(k=>{
    const v = loadout.base[k] ?? "—";
    const isWeapon = (k === "Primary" || k === "Secondary");
    const att = isWeapon ? (loadout.attachments?.[k] || []) : [];
    const showAtt = state.attachments && isWeapon && Array.isArray(att) && att.length > 0;

    const attHtml = showAtt ? `
      <div class="attach">
        <div class="attachTitle">Attachments</div>
        <div class="attachList">
          ${att.map(a=>`<div class="attachItem"><span>${escapeHtml(niceSlotName(a.slot))}</span>${escapeHtml(a.name)}</div>`).join("")}
        </div>
      </div>
    ` : (state.attachments && isWeapon ? `
      <div class="attach">
        <div class="attachTitle">Attachments</div>
        <div class="attachList">
          <div class="attachItem"><span>Info</span>No attachments for this weapon</div>
        </div>
      </div>
    ` : "");

    return `
      <div class="slot">
        <div class="slotTop"><div class="label">${escapeHtml(k)}</div></div>
        <div class="value">${escapeHtml(v)}</div>
        ${attHtml}
      </div>
    `;
  }).join("");

  elExtraWrap.classList.toggle("hidden", !state.regain);
  if(!state.regain){
    elExtraSlots.innerHTML = "";
  }else{
    elExtraSlots.innerHTML = ORDER_EXTRA.map(k=>{
      const v = loadout.extra[k] ?? "—";
      return `
        <div class="slot">
          <div class="slotTop"><div class="label">${escapeHtml(k)}</div></div>
          <div class="value">${escapeHtml(v)}</div>
        </div>
      `;
    }).join("");
  }
}

/* =========================
   CHAINS
========================= */
function getActiveChain(){
  if(!state.activeChainId) return null;
  return CHAINS.find(c=>c.id===state.activeChainId) || null;
}
function canUseChain(chain){
  if(!chain) return false;
  const mode = state.squad ? "squad" : "solo";
  return chain.modes.includes(mode);
}
function startRandomChain(){
  const mode = state.squad ? "squad" : "solo";
  const eligible = CHAINS.filter(c=>c.modes.includes(mode));
  if(!eligible.length) return null;
  const chain = pick(eligible);
  state.activeChainId = chain.id;
  state.activeChainStep = 0;
  return chain;
}
function failChain(){
  state.activeChainId = null;
  state.activeChainStep = 0;
}
function advanceChain(){
  const chain = getActiveChain();
  if(!chain) return { done:false, err:"No active chain" };
  const next = state.activeChainStep + 1;
  if(next >= chain.steps.length){
    failChain();
    return { done:true };
  }
  state.activeChainStep = next;
  return { done:false };
}
function renderChainUI(chain){
  if(!state.chains || !chain || !canUseChain(chain)){
    elChainBlock.classList.add("hidden");
    elChainBlock.innerHTML = "";
    return false;
  }
  const stepIdx = Math.min(Math.max(state.activeChainStep, 0), chain.steps.length-1);
  const step = chain.steps[stepIdx];
  elChainBlock.classList.remove("hidden");
  elChainBlock.innerHTML = `
    <div class="missionCard" style="border-color: rgba(255,209,102,.22); background: rgba(255,209,102,.06);">
      <div class="missionKey">Mission Chain</div>
      <div class="missionVal">${escapeHtml(chain.name)} — Step ${stepIdx+1}/${chain.steps.length}: ${escapeHtml(step.title)}</div>
      <div class="missionSmall">Failure resets chain. Success: advance to the next step.</div>
    </div>
  `;
  renderMission({
    title: `${chain.name}: ${step.title}`,
    subtitle: `Faction: ${chain.faction} • Chain step ${stepIdx+1}/${chain.steps.length}`,
    objectives: step.objectives,
    constraints: step.constraints,
    bonus: step.bonus
  });
  return true;
}

/* =========================
   DAILY
========================= */
function loadDaily(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY_DAILY);
    if(!raw) return null;
    const d = JSON.parse(raw);
    if(!d || !d.date) return null;
    if(d.date !== nowLocalISODate()) return null;
    return d;
  }catch{ return null; }
}
function saveDaily(d){ localStorage.setItem(STORAGE_KEY_DAILY, JSON.stringify(d)); }
function clearDaily(){ localStorage.removeItem(STORAGE_KEY_DAILY); }

function dailyBadgesHTML(d){
  const b = [
    {text:`Faction: ${d.faction}`, tone:d.factionTone || "ok"},
    {text:`Mode: ${d.squad ? "Squad" : "Solo"}`, tone:d.squad ? "warn" : "ok"},
    {text:`Difficulty: ${["Easy","Normal","Spicy"][d.difficulty]}`, tone:d.difficulty===2 ? "danger" : (d.difficulty===1 ? "warn" : "ok")},
    {text:`Chains: ${d.chains ? "ON" : "OFF"}`, tone:d.chains ? "warn" : "ok"},
    {text:`Meme↔Meta: ${d.memeMeta}%`, tone:d.memeMeta<=33 ? "warn" : "ok"}
  ];
  return b.map(x=>`<span class="badge ${x.tone}"><span class="bDot"></span>${escapeHtml(x.text)}</span>`).join("");
}

function renderDaily(d){
  dailyResetPill.textContent = `Resets: ${fmtDuration(msUntilLocalMidnight())}`;
  if(!d){
    dailyCard.classList.remove("dailyCard");
    dailyHeadline.textContent = "Not generated today";
    dailyBadges.innerHTML = "";
    dailyBody.innerHTML = `<div class="mutedNote">Click <b>Generate Daily</b> to lock in today’s run.</div>`;
    return;
  }
  dailyCard.classList.add("dailyCard");
  dailyHeadline.textContent = `${d.faction} • ${d.squad ? "Squad" : "Solo"} • ${["Easy","Normal","Spicy"][d.difficulty]} • ${d.seed}`;
  dailyBadges.innerHTML = dailyBadgesHTML(d);

  const loadoutLines = [
    `<div class="missionKey">Loadout</div>`,
    `<div class="missionSmall"><b>Primary:</b> ${escapeHtml(d.kit.base.Primary)}</div>`,
    `<div class="missionSmall"><b>Secondary:</b> ${escapeHtml(d.kit.base.Secondary)}</div>`,
    `<div class="missionSmall"><b>Tactical:</b> ${escapeHtml(d.kit.base.Tactical)}</div>`,
    `<div class="missionSmall"><b>Lethal:</b> ${escapeHtml(d.kit.base.Lethal)}</div>`,
    `<div class="missionSmall"><b>Field:</b> ${escapeHtml(d.kit.base["Field Upgrade"])}</div>`
  ];
  if(d.regain){
    loadoutLines.push(`<div class="divider"></div><div class="missionKey">Extra Gear (Regain)</div>`);
    loadoutLines.push(`<div class="missionSmall"><b>Vest:</b> ${escapeHtml(d.kit.extra.Vest)}</div>`);
    loadoutLines.push(`<div class="missionSmall"><b>Backpack:</b> ${escapeHtml(d.kit.extra.Backpack)}</div>`);
    loadoutLines.push(`<div class="missionSmall"><b>Revive:</b> ${escapeHtml(d.kit.extra.Revive)}</div>`);
    loadoutLines.push(`<div class="missionSmall"><b>Mask:</b> ${escapeHtml(d.kit.extra.Mask)}</div>`);
  }

  const missionBlock = [];
  missionBlock.push(`<div class="divider"></div><div class="missionKey">Mission</div>`);
  missionBlock.push(`<div class="missionVal">${escapeHtml(d.mission.title)}</div>`);
  missionBlock.push(`<div class="missionSmall">${escapeHtml(d.mission.subtitle || "")}</div>`);
  missionBlock.push(`<ul class="objList">${(d.mission.objectives||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`);
  if(d.mission.constraints?.length){
    missionBlock.push(`<div class="missionSmall"><b>Constraints:</b></div>`);
    missionBlock.push(`<ul class="objList">${d.mission.constraints.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`);
  }
  missionBlock.push(`<div class="missionSmall"><b>Bonus:</b> ${escapeHtml(d.mission.bonus || "")}</div>`);

  dailyBody.innerHTML = `<div class="missionCard">${loadoutLines.join("")}${missionBlock.join("")}</div>`;
}

/* =========================
   COPY EXPORT
========================= */
function buildCopyPayload(p, format){
  const modeName = p.squad ? "SQUAD" : "SOLO";
  const diffName = ["Easy","Normal","Spicy"][p.difficulty];
  const mapName = MAPS[p.mapFlavor]?.name || "Any";
  const primary = p.kit.base.Primary;
  const secondary = p.kit.base.Secondary;

  if(format === "oneline"){
    return `DMZ ${mapName} | ${p.faction} | ${modeName} ${diffName} | Meme↔Meta ${p.memeMeta}% | ${primary} + ${secondary} | ${p.mission.title}`;
  }

  if(format === "discord"){
    const lines = [];
    lines.push(`**DMZ MW2 RUN** — \`${p.seed}\``);
    lines.push(`**Faction:** ${p.faction}`);
    lines.push(`**Mode:** ${modeName}  |  **Difficulty:** ${diffName}  |  **Map:** ${mapName}`);
    lines.push(`**Meme↔Meta:** ${p.memeMeta}%  |  **Chains:** ${p.chains ? "ON" : "OFF"}`);
    lines.push("");
    lines.push(`**LOADOUT**`);
    lines.push(`• Primary: **${primary}**`);
    if(p.attachments && p.kit.attachments?.Primary?.length){
      lines.push(`  - Attachments:`);
      p.kit.attachments.Primary.forEach(a=>lines.push(`    • ${niceSlotName(a.slot)}: ${a.name}`));
    }
    lines.push(`• Secondary: **${secondary}**`);
    if(p.attachments && p.kit.attachments?.Secondary?.length){
      lines.push(`  - Attachments:`);
      p.kit.attachments.Secondary.forEach(a=>lines.push(`    • ${niceSlotName(a.slot)}: ${a.name}`));
    }
    lines.push(`• Tactical: ${p.kit.base.Tactical}`);
    lines.push(`• Lethal: ${p.kit.base.Lethal}`);
    lines.push(`• Field: ${p.kit.base["Field Upgrade"]}`);
    if(p.regain){
      lines.push(`• Extra: ${p.kit.extra.Vest}, ${p.kit.extra.Backpack}, ${p.kit.extra.Revive}, ${p.kit.extra.Mask}`);
    }
    lines.push("");
    lines.push(`**MISSION — ${p.mission.title}**`);
    if(p.mission.subtitle) lines.push(`_${p.mission.subtitle}_`);
    (p.mission.objectives||[]).forEach((o,i)=>lines.push(`• ${i+1}. ${o}`));
    if(p.mission.constraints?.length){
      lines.push("");
      lines.push(`**Constraints**`);
      p.mission.constraints.forEach(c=>lines.push(`• ${c}`));
    }
    lines.push("");
    lines.push(`**Bonus:** ${p.mission.bonus}`);
    return lines.join("\n");
  }

  if(format === "checklist"){
    const lines = [];
    lines.push(`DMZ MW2 RUN — ${p.seed}`);
    lines.push(`${p.faction} | ${modeName} | ${diffName} | ${mapName}`);
    lines.push("");
    lines.push(`LOADOUT:`);
    lines.push(`- Primary: ${primary}`);
    lines.push(`- Secondary: ${secondary}`);
    lines.push(`- Tactical: ${p.kit.base.Tactical}`);
    lines.push(`- Lethal: ${p.kit.base.Lethal}`);
    lines.push(`- Field: ${p.kit.base["Field Upgrade"]}`);
    if(p.regain) lines.push(`- Extra: ${p.kit.extra.Vest}, ${p.kit.extra.Backpack}, ${p.kit.extra.Revive}, ${p.kit.extra.Mask}`);
    lines.push("");
    lines.push(`MISSION: ${p.mission.title}`);
    (p.mission.objectives||[]).forEach(o=>lines.push(`- [ ] ${o}`));
    if(p.mission.constraints?.length){
      lines.push("");
      lines.push(`Constraints:`);
      p.mission.constraints.forEach(c=>lines.push(`- [ ] ${c}`));
    }
    lines.push("");
    lines.push(`Bonus: ${p.mission.bonus}`);
    return lines.join("\n");
  }

  // plain default
  const lines = [];
  lines.push(`DMZ MW2 — ${p.seed}`);
  lines.push(`Faction: ${p.faction}`);
  lines.push(`Mode: ${modeName} | Difficulty: ${diffName} | Map: ${mapName}`);
  lines.push(`Meme↔Meta: ${p.memeMeta}% | Chains: ${p.chains ? "ON" : "OFF"} | Regain: ${p.regain ? "ON" : "OFF"} | Attachments: ${p.attachments ? "ON" : "OFF"}`);
  lines.push("");
  lines.push(`LOADOUT:`);
  lines.push(`Primary: ${primary}`);
  lines.push(`Secondary: ${secondary}`);
  lines.push(`Tactical: ${p.kit.base.Tactical}`);
  lines.push(`Lethal: ${p.kit.base.Lethal}`);
  lines.push(`Field: ${p.kit.base["Field Upgrade"]}`);
  if(p.regain) lines.push(`Extra: ${p.kit.extra.Vest}, ${p.kit.extra.Backpack}, ${p.kit.extra.Revive}, ${p.kit.extra.Mask}`);
  if(p.attachments){
    const a1 = p.kit.attachments?.Primary || [];
    const a2 = p.kit.attachments?.Secondary || [];
    lines.push("");
    lines.push(`ATTACHMENTS:`);
    lines.push(`Primary:`);
    lines.push(a1.length ? a1.map(x=>`- ${niceSlotName(x.slot)}: ${x.name}`).join("\\n") : "- None");
    lines.push(`Secondary:`);
    lines.push(a2.length ? a2.map(x=>`- ${niceSlotName(x.slot)}: ${x.name}`).join("\\n") : "- None");
  }
  lines.push("");
  lines.push(`MISSION: ${p.mission.title}`);
  if(p.mission.subtitle) lines.push(p.mission.subtitle);
  (p.mission.objectives||[]).forEach((o,i)=>lines.push(`${i+1}) ${o}`));
  if(p.mission.constraints?.length){
    lines.push("");
    lines.push(`Constraints:`);
    p.mission.constraints.forEach(c=>lines.push(`- ${c}`));
  }
  lines.push("");
  lines.push(`Bonus: ${p.mission.bonus}`);
  return lines.join("\\n");
}

async function copyText(payload){
  const fmt = exportFormatEl.value || "plain";
  const text = buildCopyPayload(payload, fmt);
  try{
    await navigator.clipboard.writeText(text);
    showToast("Copied");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast("Copied");
  }
}

/* =========================
   MAIN ROLL
========================= */
let lastRoll = null;
let currentKit = null;
let currentMission = null;

function setNewSeed(){
  state.seed = randSeed();
  elSeed.textContent = `Seed: ${state.seed}`;
}

function syncLastRoll(){
  if(!currentKit || !currentMission) return;
  lastRoll = {
    seed: state.seed,
    faction: state.factionObj?.name || "—",
    factionTone: state.factionObj?.tone || "ok",
    regain: state.regain,
    attachments: state.attachments,
    squad: state.squad,
    chains: state.chains,
    difficulty: state.difficulty,
    mapFlavor: state.mapFlavor,
    memeMeta: state.memeMeta,
    kit: currentKit,
    mission: currentMission
  };
}

function rollLoadout(options={keepSeed:false}){
  const pools = getPools();
  if(!options.keepSeed) setNewSeed();
  if(!state.factionObj) state.factionObj = chooseFaction();
  currentKit = generateLoadout(pools);
  renderLoadout(currentKit);
  elLoadoutHeadline.textContent = `${state.regain ? "Regain ON" : "Regain OFF"} • ${state.attachments ? "Attachments ON" : "Attachments OFF"} • Meme↔Meta ${state.memeMeta}% • ${state.seed}`;
  syncLastRoll();
  saveAppState();
}

function rollMission(options={keepSeed:false}){
  if(!options.keepSeed) setNewSeed();
  const chain = getActiveChain();
  if(state.chains && chain && canUseChain(chain)){
    state.factionObj = FACTIONS.find(x=>x.name===chain.faction) || chooseFaction();
    elFactionBriefing.innerHTML = `<b>${escapeHtml(chain.faction)}:</b> ${escapeHtml(chain.briefing)}`;
    renderBadges(state.factionObj);
    renderChainUI(chain);
    const step = chain.steps[Math.min(Math.max(state.activeChainStep,0), chain.steps.length-1)];
    currentMission = {
      title: `${chain.name}: ${step.title}`,
      subtitle: `Faction: ${chain.faction} • Chain step ${state.activeChainStep+1}/${chain.steps.length}`,
      objectives: step.objectives,
      constraints: step.constraints,
      bonus: step.bonus,
      chainInfo: { name: chain.name, step: state.activeChainStep+1, steps: chain.steps.length }
    };
  } else {
    state.factionObj = chooseFaction();
    elFactionBriefing.innerHTML = `<b>${escapeHtml(state.factionObj.name)}:</b> ${escapeHtml(pick(state.factionObj.intros))}`;
    renderBadges(state.factionObj);
    elChainBlock.classList.add("hidden");
    elChainBlock.innerHTML = "";
    currentMission = buildMission();
    renderMission(currentMission);
  }
  const diffName = ["Easy","Normal","Spicy"][state.difficulty];
  const modeName = state.squad ? "Squad" : "Solo";
  const chainStatus = state.chains ? "Chains ON" : "Chains OFF";
  const mapName = MAPS[state.mapFlavor]?.name || "Any";
  elMissionHeadline.textContent = `${modeName} • ${diffName} • ${chainStatus} • ${mapName} • ${state.seed}`;
  modePill.textContent = `Mode: ${modeName}`;
  syncLastRoll();
  saveAppState();
}



function rollBoth(){
  setNewSeed();
  rollLoadout({keepSeed:true});
  rollMission({keepSeed:true});
}

/* =========================
   DAILY ACTIONS
========================= */
function generateDailyFromCurrent(){
  if(!currentKit || !currentMission) rollBoth();
  const d = { date: nowLocalISODate(), ...lastRoll };
  saveDaily(d);
  renderDaily(d);
  showToast("Daily generated");
}

/* =========================
   WIRES
========================= */
function bindToggle(id, key){
  const el = document.getElementById(id);
  setSwitch(el, state[key]);
  el.addEventListener("click", ()=>{
    state[key] = !state[key];
    setSwitch(el, state[key]);
    if(key==="chains" && !state.chains) failChain();
    saveAppState();
    rollBoth();
  });
}

document.getElementById("rollBtn").addEventListener("click", ()=>rollLoadout());
document.getElementById("rollMissionBtn").addEventListener("click", ()=>rollMission());
document.getElementById("copyBtn").addEventListener("click", ()=>{ if(!currentKit || !currentMission) rollBoth(); copyText(lastRoll); });

document.getElementById("editPoolsBtn").addEventListener("click", openModal);
document.getElementById("closeBtn").addEventListener("click", closeModal);
document.getElementById("savePoolsBtn").addEventListener("click", ()=>{ saveFromEditor(); closeModal(); rollBoth(); });
document.getElementById("resetBtn").addEventListener("click", ()=>{ resetPools(); rollBoth(); });
document.getElementById("copyJsonBtn").addEventListener("click", copyPoolsJson);

modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });
window.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(); });

diffSlider.addEventListener("input", ()=>{ state.difficulty = parseInt(diffSlider.value,10)||0; updateDifficultyUI(); saveAppState(); rollBoth(); });
mmSlider.addEventListener("input", ()=>{ state.memeMeta = parseInt(mmSlider.value,10)||0; updateMemeMetaUI(); saveAppState(); rollBoth(); });

exportFormatEl.addEventListener("change", saveAppState);
mapFlavorEl.addEventListener("change", ()=>{ state.mapFlavor = mapFlavorEl.value || "any"; saveAppState(); rollBoth(); });

bindToggle("regainSwitch","regain");
bindToggle("attachSwitch","attachments");
bindToggle("squadSwitch","squad");
bindToggle("chainsSwitch","chains");

document.getElementById("startChainBtn").addEventListener("click", ()=>{
  if(!state.chains) return showToast("Enable Mission Chains first");
  if(state.activeChainId) return showToast("Chain already active");
  const c = startRandomChain();
  if(!c) return showToast("No chains for this mode");
  saveAppState();
  showToast(`Chain started: ${c.name}`);
  rollBoth();
});
document.getElementById("advanceChainBtn").addEventListener("click", ()=>{
  if(!state.chains) return showToast("Enable Mission Chains first");
  const res = advanceChain();
  saveAppState();
  showToast(res?.done ? "Chain completed!" : "Advanced chain step");
  rollBoth();
});
document.getElementById("failChainBtn").addEventListener("click", ()=>{
  if(!state.chains) return showToast("Enable Mission Chains first");
  if(!state.activeChainId) return showToast("No active chain");
  failChain();
  saveAppState();
  showToast("Chain reset");
  rollBoth();
});

document.getElementById("dailyGenerateBtn").addEventListener("click", ()=>{
  const existing = loadDaily();
  if(existing) return showToast("Daily already generated today");
  generateDailyFromCurrent();
});
document.getElementById("dailyCopyBtn").addEventListener("click", ()=>{
  const d = loadDaily();
  if(!d) return showToast("No daily run today");
  copyText(d);
});
document.getElementById("dailyClearBtn").addEventListener("click", ()=>{
  clearDaily();
  renderDaily(null);
  showToast("Daily cleared");
});

/* =========================
   INIT
========================= */
(function init(){
  loadAppState();
  updateDifficultyUI();
  updateMemeMetaUI();

  mapFlavorEl.value = state.mapFlavor;
  diffSlider.value = String(state.difficulty);
  mmSlider.value = String(state.memeMeta);

  setSwitch(document.getElementById("regainSwitch"), state.regain);
  setSwitch(document.getElementById("attachSwitch"), state.attachments);
  setSwitch(document.getElementById("squadSwitch"), state.squad);
  setSwitch(document.getElementById("chainsSwitch"), state.chains);

  if(!state.chains) failChain();

  renderDaily(loadDaily());
  dailyResetPill.textContent = `Resets: ${fmtDuration(msUntilLocalMidnight())}`;
  setInterval(()=>{ dailyResetPill.textContent = `Resets: ${fmtDuration(msUntilLocalMidnight())}`; }, 30_000);

  rollBoth();
})();
</script>
</body>
</html>
