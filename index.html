<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DMZ MW2 Loadout + Mission Generator</title>
  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1220;
      --text:#EAF1FF; --muted:#A9B7D6;
      --accent:#6BE4FF; --accent2:#9B7CFF;
      --border:rgba(255,255,255,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 22px;
      --danger:#FF5C7A;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(155,124,255,.25), transparent 60%),
        radial-gradient(900px 700px at 100% 20%, rgba(107,228,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .wrap{
      width:min(1200px, 100%);
      display:grid;
      gap:18px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
      padding:14px 16px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h1{margin:0; font-size:18px; letter-spacing:.5px}
    .title p{margin:0; color:var(--muted); font-size:13px; line-height:1.35}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 0 16px rgba(107,228,255,.4);
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .cardHeader h2{margin:0; font-size:14px; letter-spacing:.8px; color:var(--muted); text-transform:uppercase}
    .cardHeader .sub{margin-top:4px; color:rgba(234,241,255,.92); font-size:18px; font-weight:650}
    .sectionBody{padding:14px;}
    .grid2{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 560px){ .grid2{grid-template-columns:1fr} }

    .slot{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(14,26,46,.75), rgba(11,22,40,.75));
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .slot::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 160px at 10% 0%, rgba(107,228,255,.12), transparent 55%),
                  radial-gradient(520px 180px at 90% 10%, rgba(155,124,255,.12), transparent 55%);
      pointer-events:none;
    }
    .slotTop{display:flex; align-items:center; justify-content:space-between; gap:8px; position:relative;}
    .label{color:var(--muted); font-size:12px; letter-spacing:.5px; text-transform:uppercase;}
    .value{margin-top:6px; font-size:16px; font-weight:650; position:relative;}
    .attach{
      margin-top:10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top:8px;
      position:relative;
    }
    .attachTitle{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .attachList{
      margin-top:6px;
      display:grid;
      gap:4px;
    }
    .attachItem{
      font-size:12px;
      color:rgba(234,241,255,.92);
      line-height:1.25;
    }
    .attachItem span{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.35px;
      font-size:11px;
      margin-right:6px;
    }

    .missionLine{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding:12px;
      margin-bottom:10px;
    }
    .missionLine:last-child{margin-bottom:0}
    .missionKey{font-size:12px; color:var(--muted); letter-spacing:.5px; text-transform:uppercase;}
    .missionVal{font-size:15px; font-weight:650; line-height:1.25; margin-top:6px;}
    .missionHint{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35;}

    .controls{
      padding:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.12));
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:none;
      border-radius: 16px;
      padding:12px 14px;
      font-size:14px;
      font-weight:700;
      letter-spacing:.4px;
      cursor:pointer;
    }
    button.primary{
      color:#061018;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 40px rgba(107,228,255,.18);
    }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.12);
      font-weight:650;
    }
    button.danger{
      color:rgba(255,255,255,.95);
      background: rgba(255,92,122,.12);
      border:1px solid rgba(255,92,122,.35);
      font-weight:700;
    }

    .side{display:flex; flex-direction:column; gap:18px;}
    .panel{padding:14px 14px 12px;}
    .panel h3{ margin:0 0 8px; font-size:14px; letter-spacing:.7px; text-transform:uppercase; color:var(--muted); }

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
    }
    .toggle .tL{display:flex; flex-direction:column; gap:4px;}
    .toggle .tL b{font-size:14px}
    .toggle .tL span{font-size:12px; color:var(--muted)}
    .switch{
      width:44px; height:26px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      position:relative;
      cursor:pointer;
      flex:0 0 auto;
      user-select:none;
    }
    .switch::after{
      content:"";
      width:20px; height:20px;
      border-radius:999px;
      position:absolute;
      top:50%; left:3px;
      transform:translateY(-50%);
      background: rgba(234,241,255,.86);
      transition: left .15s ease, background .15s ease;
    }
    .switch[data-on="true"]{ border-color: rgba(107,228,255,.35); background: rgba(107,228,255,.12); }
    .switch[data-on="true"]::after{ left:21px; background: linear-gradient(90deg, var(--accent), var(--accent2)); }

    .sliderBox{
      padding:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
    }
    .sliderTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;}
    .sliderTop b{font-size:14px}
    .sliderTop span{font-size:12px; color:var(--muted)}
    input[type="range"]{width:100%}
    .mutedNote{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.4}
    .hidden{display:none !important;}

    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(10,16,28,.92);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(234,241,255,.95);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      font-size: 13px;
      z-index: 99;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px);}

    /* Pools Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 100;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(1100px, 100%);
      max-height: 88svh;
      overflow:auto;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(18,28,48,.96), rgba(10,16,28,.96));
      box-shadow: var(--shadow);
    }
    .modalTop{
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(18,28,48,.98), rgba(18,28,48,.88));
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .modalTop h4{margin:0; font-size:14px; letter-spacing:.7px; text-transform:uppercase; color:var(--muted);}
    .modalTop .small{margin-top:6px; color:rgba(234,241,255,.90); font-size:13px; line-height:1.35;}
    .modalBody{padding:14px 16px;}
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:900px){ .modalGrid{grid-template-columns:1fr} }
    .poolBox{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .poolBox h5{margin:0 0 6px; font-size:13px; letter-spacing:.5px; text-transform:uppercase; color:rgba(234,241,255,.92);}
    .poolBox .hint{margin:0 0 10px; font-size:12px; color:var(--muted); line-height:1.35;}
    textarea{
      width:100%;
      min-height: 170px;
      resize:vertical;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(234,241,255,.92);
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      line-height:1.4;
    }
    .modalActions{
      position:sticky; bottom:0;
      background: linear-gradient(180deg, rgba(10,16,28,.30), rgba(10,16,28,.92));
      border-top:1px solid rgba(255,255,255,.10);
      padding:12px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(234,241,255,.9);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:3px 7px;
      border-radius: 10px;
      margin-left: 6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div>
      <div class="brand">
        <div class="title">
          <h1>DMZ MW2 Loadout + Mission Generator</h1>
          <p>DMZ (MW2) only • Regain adds extra slots only • Attachments + Solo/Squad toggles affect missions/weapon details only (as labeled)</p>
        </div>
        <div class="pill"><span class="dot"></span><span id="seedLabel">Seed: —</span></div>
      </div>

      <!-- LOADOUT -->
      <div class="card" style="margin-top:14px;">
        <div class="cardHeader">
          <div>
            <h2>Loadout</h2>
            <div class="sub" id="loadoutHeadline">Tap ROLL to generate</div>
          </div>
          <div class="pill" title="Primary + Secondary draw from ALL MW2 weapons (including RPG-7)">Every MW2 weapon enabled</div>
        </div>

        <div class="sectionBody">
          <div class="mutedNote" style="margin-bottom:10px;">
            <b>Base Infil Kit</b> always rolls. <b>Regain Mode</b> adds Vest/Backpack/Revive/Mask slots only.
            <br><b>Random Attachments</b> adds attachments to Primary/Secondary.
          </div>

          <div class="grid2" id="baseLoadoutSlots"></div>

          <div id="extraGearWrap" class="hidden" style="margin-top:12px;">
            <div class="mutedNote" style="margin-bottom:10px;"><b>Extra Gear (Regain)</b></div>
            <div class="grid2" id="extraLoadoutSlots"></div>
          </div>
        </div>

        <div class="controls">
          <div class="btnRow">
            <button class="primary" id="rollBtn">ROLL</button>
            <button class="secondary" id="copyBtn">Copy</button>
            <button class="secondary" id="editPoolsBtn" title="Edit the pools without cluttering the main screen">Edit Pools</button>
          </div>
          <div class="mutedNote">OBS: add as Browser Source • Copy for chat/title</div>
        </div>
      </div>

      <!-- MISSION -->
      <div class="card" style="margin-top:14px;">
        <div class="cardHeader">
          <div>
            <h2>Mission</h2>
            <div class="sub" id="missionHeadline">Tap ROLL to generate</div>
          </div>
          <div class="pill" id="modePill" title="Solo/Squad changes mission flavor">Mode: Solo</div>
        </div>
        <div class="sectionBody" id="missionBody"></div>
      </div>
    </div>

    <!-- SIDE -->
    <div class="side">
      <div class="card panel">
        <h3>Mission Difficulty</h3>
        <div class="sliderBox">
          <div class="sliderTop">
            <b id="diffLabel">Easy</b>
            <span id="diffHint">High completion</span>
          </div>
          <input id="diffSlider" type="range" min="0" max="2" step="1" value="0" />
        </div>
      </div>

      <div class="card panel">
        <h3>Run Settings</h3>

        <div class="toggle">
          <div class="tL">
            <b>Regain Mode</b>
            <span>Adds Vest/Backpack/Revive/Mask slots</span>
          </div>
          <div class="switch" id="regainSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="toggle" style="margin-top:10px;">
          <div class="tL">
            <b>Random Attachments</b>
            <span>Adds attachments to Primary/Secondary</span>
          </div>
          <div class="switch" id="attachSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="toggle" style="margin-top:10px;">
          <div class="tL">
            <b>Squad Missions</b>
            <span>Harder missions that require teammates</span>
          </div>
          <div class="switch" id="squadSwitch" data-on="false" role="switch" aria-checked="false"></div>
        </div>

        <div class="mutedNote" style="margin-top:10px;">
          If you notice a missing weapon, hit <b>Edit Pools</b> and paste it in.
        </div>
      </div>

      <div class="card panel">
        <h3>Share</h3>
        <div class="mutedNote" style="margin-top:0;">
          GitHub Pages link is your stream link.<br>
          Example: <span style="color:rgba(234,241,255,.9)">https://USERNAME.github.io/REPO/</span>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- POOLS MODAL -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Edit Pools">
      <div class="modalTop">
        <div>
          <h4>Edit Pools</h4>
          <div class="small">
            One item per line • blanks ignored • duplicates removed • saved to your browser.<br>
            Close with <span class="kbd">Esc</span>
          </div>
        </div>
        <div class="btnRow">
          <button class="secondary" id="copyJsonBtn">Copy JSON</button>
          <button class="danger" id="resetBtn">Reset Defaults</button>
          <button class="secondary" id="closeBtn">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="modalGrid" id="modalGrid"></div>
      </div>

      <div class="modalActions">
        <div class="mutedNote" style="margin:0;">After saving, hit <b>ROLL</b> to see changes.</div>
        <div class="btnRow">
          <button class="primary" id="savePoolsBtn">Save Pools</button>
        </div>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = "dmz_mw2_pools_v4";

/* Pools (unchanged) */
const DEFAULT_POOLS = {
  ALL_WEAPONS: [
    "M4","TAQ-56","Kastov 762","Lachmann-556","STB 556","M16","Kastov-74u","Kastov 545",
    "M13B","Chimera","ISO Hemlock","Tempus Razorback","FR Avancer","M13C","TR-76 Geist",
    "Lachmann-762","SO-14","TAQ-V","FTAC Recon","Cronen Squall",
    "VEL 46","MX9","Lachmann Sub","Vaznev-9K","FSS Hurricane","Minibak","PDSW 528","Fennec 45","BAS-P",
    "ISO 45","Lachmann Shroud",
    "SAKIN MG38","HCR 56","556 Icarus","RAAL MG","RPK","RAPP H",
    "Lockwood 300","Expedite 12","Bryson 800","Bryson 890","KV Broadside","MX Guardian",
    "EBR-14","SP-R 208","Lockwood MK2","LM-S","SA-B 50","TAQ-M","Crossbow","Tempus Torrent",
    "MCPR-300","Signal 50","LA-B 330","SP-X 80","Victus XMR","FJX Imperium","Carrack .300",
    "P890",".50 GS","X12","Basilisk","X13 Auto","FTac Siege","GS Magna","9mm Daemon",
    "RPG-7","PILA","JOKR","Strela-P",
    "Riot Shield","Combat Knife","Dual Kodachis","Tonfa","Pickaxe","Dual Kamas"
  ],
  TACTICAL: [
    "Flash Grenade","Stun Grenade","Smoke Grenade","Snapshot Grenade","Tear Gas",
    "Stim","Decoy Grenade","Heartbeat Sensor","Shock Stick","Spotter Scope"
  ],
  LETHAL: [
    "Frag Grenade","Semtex","Drill Charge","Molotov Cocktail","Throwing Knife",
    "Proximity Mine","Thermite","C4","Claymore"
  ],
  FIELD_UPGRADE: [
    "Munitions Box","Armor Box","Trophy System","Dead Silence","Recon Drone"
  ],
  VEST: [
    "2-Plate Vest","3-Plate Vest","3-Plate Comms Vest","3-Plate Medic Vest","3-Plate Stealth Vest"
  ],
  BACKPACK: ["Small Backpack","Medium Backpack","Large Backpack"],
  REVIVE: ["Self-Revive Kit","Revive Pistol"],
  MASK: ["Gas Mask","Durable Gas Mask","Radiation Blocker"]
};

/* Weapon type lookup for attachments (unchanged) */
const WEAPON_TYPE = {
  RIFLE: new Set([
    "M4","TAQ-56","Kastov 762","Lachmann-556","STB 556","M16","Kastov-74u","Kastov 545",
    "M13B","Chimera","ISO Hemlock","Tempus Razorback","FR Avancer","M13C","TR-76 Geist",
    "Lachmann-762","SO-14","TAQ-V","FTAC Recon","Cronen Squall",
    "VEL 46","MX9","Lachmann Sub","Vaznev-9K","FSS Hurricane","Minibak","PDSW 528","Fennec 45","BAS-P",
    "ISO 45","Lachmann Shroud",
    "SAKIN MG38","HCR 56","556 Icarus","RAAL MG","RPK","RAPP H",
    "EBR-14","SP-R 208","Lockwood MK2","LM-S","SA-B 50","TAQ-M","Tempus Torrent",
    "MCPR-300","Signal 50","LA-B 330","SP-X 80","Victus XMR","FJX Imperium","Carrack .300"
  ]),
  SHOTGUN: new Set(["Lockwood 300","Expedite 12","Bryson 800","Bryson 890","KV Broadside","MX Guardian"]),
  PISTOL: new Set(["P890",".50 GS","X12","Basilisk","X13 Auto","FTac Siege","GS Magna","9mm Daemon"]),
  LAUNCHER: new Set(["RPG-7","PILA","JOKR","Strela-P"]),
  MELEE: new Set(["Riot Shield","Combat Knife","Dual Kodachis","Tonfa","Pickaxe","Dual Kamas"]),
  SPECIAL: new Set(["Crossbow"])
};

const ATTACH_POOLS = {
  OPTIC: [
    "Cronen Mini Pro","Slimline Pro","VLK 4.0 Optic","Aim OP-V4","SZ Holotherm",
    "Cronen C480 Pro Optic","Xten Angel-40","DF105 Reflex Sight","Thermo-Optic X9"
  ],
  MUZZLE: [
    "Sakin Tread-40","Echoless-80","Harbinger D20","Lockshot KT85","Komodo Heavy",
    "Bryson Choke","XTEN Ported 290","RF Crown 50"
  ],
  BARREL: [
    "Long Barrel","Heavy Barrel","Short Barrel","Precision Barrel","Rifle-Length Barrel",
    "XRK Barrel","FTAC Barrel","Hightower Barrel"
  ],
  UNDERBARREL: [
    "FSS Sharkfin 90","Edge-47 Grip","Commando Foregrip","FTAC Ripper 56","VX Pineapple","Bipod (if available)"
  ],
  MAGAZINE: [
    "Extended Mag","High Capacity Mag","Fast Mag","Drum Mag (if available)","Small Caliber Mag"
  ],
  LASER: [
    "FSS OLE-V Laser","VLK LZR 7mW","1mW Quick Fire Laser","Hipfire Laser","Laser Box"
  ],
  STOCK: [
    "Heavy Stock","Light Stock","No Stock","Tactical Stock","Precision Stock"
  ],
  REAR_GRIP: [
    "Granular Grip","Stippled Grip Tape","Rubberized Grip Tape","Ergonomic Grip","Recoil Grip"
  ],
  AMMO: [
    "High Velocity","Armor Piercing","Hollowpoint","Incendiary","Frangible"
  ],
  BOLT: ["Fast Bolt","Light Bolt","Heavy Bolt"],
  GUARD: ["Guard: Tactical","Guard: Heavy","Guard: Lightweight"],
  TRIGGER: ["Hair Trigger","Match Trigger","Heavy Trigger","Quickdraw Trigger"]
};

const ATTACH_SLOTS_BY_TYPE = {
  RIFLE: ["OPTIC","MUZZLE","BARREL","UNDERBARREL","MAGAZINE","LASER","STOCK","REAR_GRIP","AMMO"],
  SHOTGUN: ["OPTIC","MUZZLE","BARREL","UNDERBARREL","MAGAZINE","LASER","STOCK","GUARD","AMMO"],
  PISTOL: ["OPTIC","MUZZLE","BARREL","MAGAZINE","LASER","REAR_GRIP","AMMO","TRIGGER"],
  SPECIAL: ["OPTIC","UNDERBARREL","AMMO","BOLT"],
  LAUNCHER: [],
  MELEE: []
};

/* SOLO vs SQUAD missions (SQUAD are harder + teammate-dependent). */
const SOLO_MISSIONS = {
  easy: {
    objective: [
      "Complete 1 contract and exfil",
      "Clear 1 Stronghold and exfil",
      "Loot 1 locked space and exfil",
      "Extract with $20,000+ cash/value",
      "Extract 3 valuables (any type)"
    ],
    approach: [
      "Pick the closest contract and commit; don’t cross the whole map",
      "Plates first, then objective. Reset early if it gets messy",
      "Use smoke for rotations; avoid open crossings when possible",
      "Route: objective → quick loot → exfil (no greedy detours)",
      "If the lobby is hot, downshift to survival and take the safe exfil"
    ],
    constraint: [
      "Avoid PvP unless fired upon",
      "No UAV Towers",
      "No vehicles",
      "Stay within one POI area",
      "No constraint (clean run)"
    ],
    bonus: [
      "Exfil first available chopper",
      "Extract without going down",
      "Extract with full plates",
      "Revive someone before exfil (if possible)",
      "No bonus (clean run)"
    ]
  },
  normal: {
    objective: [
      "Complete 2 contracts and exfil",
      "Clear 1 Stronghold + complete 1 contract",
      "Loot 1 locked space + extract $20,000+",
      "Extract with $30,000+ cash/value",
      "Extract 5 valuables (any type)"
    ],
    approach: [
      "Run two contracts in nearby POIs; avoid long rotations",
      "Stronghold only after you have plates/ammo; leave if it’s messy",
      "Grab the objective items, then instantly rotate to exfil",
      "If you get into a fight, finish it fast or disengage—no ego",
      "Use one POI as your base; treat everything else as optional"
    ],
    constraint: [
      "No Buy Stations",
      "No UAV Towers",
      "Avoid PvP unless fired upon",
      "No vehicles",
      "One weapon only",
      "Must cross a river/canal at least once"
    ],
    bonus: [
      "Exfil without using a field upgrade",
      "Extract with at least 2 spare plate stacks",
      "Use only one ammo resupply (box or station)",
      "No bonus (clean run)"
    ]
  },
  spicy: {
    objective: [
      "Complete 3 contracts",
      "Clear 2 Strongholds",
      "Extract with $40,000+ cash/value",
      "Loot 2 locked spaces",
      "Acquire any killstreak in-match and exfil with it"
    ],
    approach: [
      "Pick a tight triangle route: contract → contract → exfil",
      "If you take a fight, commit—don’t bleed plates in a stalemate",
      "Use rotations + smoke to cross open areas; avoid predictable lines",
      "If the raid turns chaotic, reset early; don’t throw the run",
      "Treat final exfil as optional unless it’s clearly safe"
    ],
    constraint: [
      "No Buy Stations",
      "No UAV Towers",
      "No vehicles",
      "One weapon only",
      "No suppressors",
      "Avoid PvP unless fired upon"
    ],
    bonus: [
      "Exfil at final chopper (if safe)",
      "Extract without dying (full run)",
      "Revive a teammate/operator (if possible)",
      "No bonus (clean run)"
    ]
  }
};

const SQUAD_MISSIONS = {
  easy: {
    objective: [
      "As a squad, complete 2 contracts and exfil together",
      "Clear 1 Stronghold as a squad and exfil together",
      "Squad must extract $40,000+ combined value",
      "Complete 1 contract and exfil with all squad members alive",
      "Secure 1 locked space and exfil together"
    ],
    approach: [
      "Assign roles: entry (front), support (plates), anchor (rear). Move as a unit",
      "Call targets and plate breaks—no silent fights",
      "Rotate together; if one lags, the whole squad slows",
      "Stack streaks/boxes: one drops munitions, one drops armor",
      "If engaged, two hold angles while one flanks or smokes"
    ],
    constraint: [
      "Stay within 50 meters of at least one teammate at all times",
      "No splitting into 1v1 fights (must push as 2+)",
      "No UAV Towers",
      "No vehicles",
      "No Buy Stations"
    ],
    bonus: [
      "Exfil with all three players and no one goes down",
      "Win one squad fight then immediately exfil",
      "Extract with 3 spare self-revives across the team",
      "No bonus (clean run)"
    ]
  },
  normal: {
    objective: [
      "Complete 3 contracts as a squad and exfil together",
      "Clear 2 Strongholds and extract a key item (any valuable) as a team",
      "Squad must extract $60,000+ combined value",
      "Acquire a killstreak for each teammate and exfil together",
      "Complete a contract, then immediately complete a second contract in a different POI"
    ],
    approach: [
      "Use comms discipline: short callouts, confirm downs, confirm wipes",
      "One player carries smokes; one carries stuns; one carries lethals",
      "If one gets cracked, rotate and re-plate before re-peeking",
      "Avoid long looting—objective first, then quick sweep, then rotate",
      "Two hold, one moves: never all three crossing open ground at once"
    ],
    constraint: [
      "Must revive a teammate at least once (if possible) before exfil",
      "No Buy Stations",
      "No UAV Towers",
      "No vehicles",
      "Two teammates must use different weapon classes (e.g., SMG + Sniper)"
    ],
    bonus: [
      "Exfil at final chopper (only if safe)",
      "Extract with all teammates having 3-plates (any kind)",
      "Complete one hunt-style engagement then disengage and exfil",
      "No bonus (clean run)"
    ]
  },
  spicy: {
    objective: [
      "As a squad, complete 4 contracts OR 3 contracts + 2 Strongholds",
      "Squad must extract $80,000+ combined value",
      "Win a full squad fight (wipe) and then complete 2 contracts",
      "Clear 2 Strongholds, loot 2 locked spaces, and exfil together",
      "Do a ‘rescue run’: revive another operator team member (assimilation ok) and exfil together"
    ],
    approach: [
      "Run a real execute: entry pair + overwatch. Move on countdowns",
      "If a fight stalls past 30 seconds, reposition—don’t bleed plates",
      "Use smokes to cross; use stuns to break corners; finish downs fast",
      "Always keep one player as anchor watching third-party angles",
      "Commit to rotations—don’t get baited into endless roof wars"
    ],
    constraint: [
      "No Buy Stations",
      "No UAV Towers",
      "No vehicles",
      "Stay within 40 meters of a teammate at all times",
      "Must take and win at least one squad engagement before exfil"
    ],
    bonus: [
      "Final exfil (only if safe)",
      "Extract without any teammate dying (full wipe avoided)",
      "Extract with 2+ killstreaks across the squad",
      "No bonus (clean run)"
    ]
  }
};

const ORDER_BASE = ["Primary","Secondary","Tactical","Lethal","Field Upgrade"];
const ORDER_EXTRA = ["Vest","Backpack","Revive","Mask"];

const state = { seed:null, regain:false, attachments:false, squad:false, difficulty:0 };

const elSeed = document.getElementById("seedLabel");
const toast = document.getElementById("toast");
const elLoadoutHeadline = document.getElementById("loadoutHeadline");
const elMissionHeadline = document.getElementById("missionHeadline");
const elBaseSlots = document.getElementById("baseLoadoutSlots");
const elExtraWrap = document.getElementById("extraGearWrap");
const elExtraSlots = document.getElementById("extraLoadoutSlots");
const elMissionBody = document.getElementById("missionBody");
const diffSlider = document.getElementById("diffSlider");
const diffLabel = document.getElementById("diffLabel");
const diffHint = document.getElementById("diffHint");
const modePill = document.getElementById("modePill");

const modalOverlay = document.getElementById("modalOverlay");
const modalGrid = document.getElementById("modalGrid");

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1200);
}
function randSeed(){ return Math.random().toString(36).slice(2, 8).toUpperCase(); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function difficultyKey(){
  return state.difficulty === 0 ? "easy" : (state.difficulty === 1 ? "normal" : "spicy");
}
function updateDifficultyUI(){
  const labels = ["Easy","Normal","Spicy"];
  const hints = ["High completion","Balanced","More demanding"];
  diffLabel.textContent = labels[state.difficulty];
  diffHint.textContent = hints[state.difficulty];
  diffSlider.value = String(state.difficulty);
}
function normalizeList(text){
  return Array.from(new Set(
    String(text || "")
      .split("\n")
      .map(x=>x.trim())
      .filter(Boolean)
  ));
}
function loadPools(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(DEFAULT_POOLS);
    const parsed = JSON.parse(raw);
    const merged = { ...structuredClone(DEFAULT_POOLS), ...parsed };
    for(const k of Object.keys(merged)){
      if(!Array.isArray(merged[k])) merged[k] = [];
      merged[k] = Array.from(new Set(merged[k].map(x=>String(x).trim()).filter(Boolean)));
    }
    return merged;
  }catch{
    return structuredClone(DEFAULT_POOLS);
  }
}
function savePools(pools){
  const safe = { ...structuredClone(DEFAULT_POOLS), ...pools };
  for(const k of Object.keys(safe)){
    if(!Array.isArray(safe[k])) safe[k] = [];
    safe[k] = Array.from(new Set(safe[k].map(x=>String(x).trim()).filter(Boolean)));
  }
  localStorage.setItem(STORAGE_KEY, JSON.stringify(safe, null, 2));
}
function getPools(){ return loadPools(); }

function getWeaponType(weaponName){
  if(WEAPON_TYPE.LAUNCHER.has(weaponName)) return "LAUNCHER";
  if(WEAPON_TYPE.MELEE.has(weaponName)) return "MELEE";
  if(WEAPON_TYPE.SHOTGUN.has(weaponName)) return "SHOTGUN";
  if(WEAPON_TYPE.PISTOL.has(weaponName)) return "PISTOL";
  if(WEAPON_TYPE.SPECIAL.has(weaponName)) return "SPECIAL";
  if(WEAPON_TYPE.RIFLE.has(weaponName)) return "RIFLE";
  return "RIFLE";
}
function rollAttachmentsForWeapon(weaponName){
  const type = getWeaponType(weaponName);
  const slots = ATTACH_SLOTS_BY_TYPE[type] || [];
  if(!slots.length) return [];
  const shuffledSlots = slots.slice().sort(()=>Math.random()-0.5);
  const takeN = Math.min(5, shuffledSlots.length);
  const chosenSlots = shuffledSlots.slice(0, takeN);
  const att = [];
  for(const slotKey of chosenSlots){
    const pool = ATTACH_POOLS[slotKey] || [];
    if(!pool.length) continue;
    att.push({ slot: slotKey, name: pick(pool) });
  }
  return att;
}
function niceSlotName(slotKey){
  return ({
    OPTIC:"Optic",
    MUZZLE:"Muzzle",
    BARREL:"Barrel",
    UNDERBARREL:"Underbarrel",
    MAGAZINE:"Magazine",
    LASER:"Laser",
    STOCK:"Stock",
    REAR_GRIP:"Rear Grip",
    AMMO:"Ammunition",
    BOLT:"Bolt",
    GUARD:"Guard",
    TRIGGER:"Trigger"
  })[slotKey] || slotKey;
}

/* Loadout generation */
function generateLoadout(pools){
  const allWeapons = pools.ALL_WEAPONS ?? [];
  const primary = pick(allWeapons) || "—";

  let secondary = pick(allWeapons) || "—";
  if(allWeapons.length > 1){
    while(secondary === primary){
      secondary = pick(allWeapons) || "—";
    }
  }

  const base = {
    Primary: primary,
    Secondary: secondary,
    Tactical: pick(pools.TACTICAL ?? []) || "—",
    Lethal: pick(pools.LETHAL ?? []) || "—",
    "Field Upgrade": pick(pools.FIELD_UPGRADE ?? []) || "—"
  };

  const extra = {};
  if(state.regain){
    extra.Vest = pick(pools.VEST ?? []) || "—";
    extra.Backpack = pick(pools.BACKPACK ?? []) || "—";
    extra.Revive = pick(pools.REVIVE ?? []) || "—";
    extra.Mask = pick(pools.MASK ?? []) || "—";
  }

  const attachments = {};
  if(state.attachments){
    attachments.Primary = rollAttachmentsForWeapon(primary);
    attachments.Secondary = rollAttachmentsForWeapon(secondary);
  }

  return { base, extra, attachments };
}

/* Mission generation: SOLO vs SQUAD (squad is harder and teammate dependent). */
function generateMission(){
  const key = difficultyKey();
  const bank = state.squad ? SQUAD_MISSIONS[key] : SOLO_MISSIONS[key];
  return {
    Objective: pick(bank.objective),
    Approach: pick(bank.approach),
    Constraint: pick(bank.constraint),
    "Optional Bonus": pick(bank.bonus)
  };
}

function renderLoadout(loadout){
  elBaseSlots.innerHTML = ORDER_BASE.map(k=>{
    const v = loadout.base[k] ?? "—";
    const isWeapon = (k === "Primary" || k === "Secondary");
    const att = isWeapon ? (loadout.attachments?.[k] || []) : [];
    const showAtt = state.attachments && isWeapon && Array.isArray(att) && att.length > 0;

    const attHtml = showAtt ? `
      <div class="attach">
        <div class="attachTitle">Attachments</div>
        <div class="attachList">
          ${att.map(a=>`
            <div class="attachItem"><span>${escapeHtml(niceSlotName(a.slot))}</span>${escapeHtml(a.name)}</div>
          `).join("")}
        </div>
      </div>
    ` : (state.attachments && isWeapon ? `
      <div class="attach">
        <div class="attachTitle">Attachments</div>
        <div class="attachList">
          <div class="attachItem"><span>Info</span>No attachments for this weapon</div>
        </div>
      </div>
    ` : "");

    return `
      <div class="slot">
        <div class="slotTop"><div class="label">${escapeHtml(k)}</div></div>
        <div class="value">${escapeHtml(v)}</div>
        ${attHtml}
      </div>
    `;
  }).join("");

  elExtraWrap.classList.toggle("hidden", !state.regain);
  if(!state.regain){
    elExtraSlots.innerHTML = "";
  }else{
    elExtraSlots.innerHTML = ORDER_EXTRA.map(k=>{
      const v = loadout.extra[k] ?? "—";
      return `
        <div class="slot">
          <div class="slotTop"><div class="label">${escapeHtml(k)}</div></div>
          <div class="value">${escapeHtml(v)}</div>
        </div>
      `;
    }).join("");
  }
}

function renderMission(m){
  const modeLine = state.squad ? "Squad mission (requires teammates)" : "Solo mission";
  const lines = [
    {k:"Objective", hint: modeLine},
    {k:"Approach", hint:"How to execute it (routing / pace / priorities)."},
    {k:"Constraint", hint:"Rule that adds tension without being impossible."},
    {k:"Optional Bonus", hint:"Extra spice only if the raid is calm."}
  ];
  elMissionBody.innerHTML = lines.map(x=>{
    return `
      <div class="missionLine">
        <div class="missionKey">${escapeHtml(x.k)}</div>
        <div class="missionVal">${escapeHtml(m[x.k] ?? "—")}</div>
        <div class="missionHint">${escapeHtml(x.hint)}</div>
      </div>
    `;
  }).join("");
}

let lastRoll = null;

function roll(){
  const pools = getPools();

  state.seed = randSeed();
  elSeed.textContent = `Seed: ${state.seed}`;

  const kit = generateLoadout(pools);
  const mission = generateMission();

  lastRoll = { kit, mission, seed: state.seed };

  elLoadoutHeadline.textContent =
    `${state.regain ? "Regain ON" : "Regain OFF"} • ` +
    `${state.attachments ? "Attachments ON" : "Attachments OFF"} • ${state.seed}`;

  elMissionHeadline.textContent =
    `${state.squad ? "Squad" : "Solo"} • ${["Easy","Normal","Spicy"][state.difficulty]} • ${state.seed}`;

  modePill.textContent = `Mode: ${state.squad ? "Squad" : "Solo"}`;

  renderLoadout(kit);
  renderMission(mission);
}

async function copyText(){
  const snapshot = lastRoll || { kit: null, mission: null, seed: state.seed || "—" };
  const kit = snapshot.kit;
  const mission = snapshot.mission;

  const blocks = [];
  blocks.push(`DMZ MW2 GENERATOR — ${snapshot.seed ?? "—"}`);
  blocks.push(`Mode: ${state.squad ? "SQUAD (teammates required)" : "SOLO"}`);
  blocks.push(`Regain: ${state.regain ? "ON (Extra Slots Added)" : "OFF (Base Kit)"}`);
  blocks.push(`Attachments: ${state.attachments ? "ON" : "OFF"}`);
  blocks.push(`Mission Difficulty: ${["Easy","Normal","Spicy"][state.difficulty]}`);
  blocks.push("");

  if(kit){
    blocks.push("LOADOUT (BASE):");
    blocks.push(`Primary: ${kit.base.Primary}`);
    if(state.attachments){
      const a = kit.attachments?.Primary || [];
      blocks.push(`Primary Attachments:`);
      if(a.length) a.forEach(x=>blocks.push(`- ${niceSlotName(x.slot)}: ${x.name}`));
      else blocks.push(`- None`);
    }
    blocks.push(`Secondary: ${kit.base.Secondary}`);
    if(state.attachments){
      const a = kit.attachments?.Secondary || [];
      blocks.push(`Secondary Attachments:`);
      if(a.length) a.forEach(x=>blocks.push(`- ${niceSlotName(x.slot)}: ${x.name}`));
      else blocks.push(`- None`);
    }
    blocks.push(`Tactical: ${kit.base.Tactical}`);
    blocks.push(`Lethal: ${kit.base.Lethal}`);
    blocks.push(`Field Upgrade: ${kit.base["Field Upgrade"]}`);

    if(state.regain){
      blocks.push("");
      blocks.push("LOADOUT (EXTRA):");
      blocks.push(`Vest: ${kit.extra.Vest}`);
      blocks.push(`Backpack: ${kit.extra.Backpack}`);
      blocks.push(`Revive: ${kit.extra.Revive}`);
      blocks.push(`Mask: ${kit.extra.Mask}`);
    }
  }

  if(mission){
    blocks.push("");
    blocks.push("MISSION:");
    Object.keys(mission).forEach(k=>blocks.push(`${k}: ${mission[k]}`));
  }

  const text = blocks.join("\n");

  try{
    await navigator.clipboard.writeText(text);
    showToast("Copied");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    showToast("Copied");
  }
}

function setSwitch(el, on){
  el.dataset.on = on ? "true" : "false";
  el.setAttribute("aria-checked", on ? "true" : "false");
}

/* ---- Pools modal ---- */
const POOL_FIELDS = [
  ["ALL_WEAPONS","All MW2 Weapons (Primary + Secondary)","Every MW2 weapon can roll here. One per line."],
  ["TACTICAL","Tactical","One per line."],
  ["LETHAL","Lethal","One per line."],
  ["FIELD_UPGRADE","Field Upgrade","One per line."],
  ["VEST","Vest (Regain extra slot)","Only appears when Regain is ON."],
  ["BACKPACK","Backpack (Regain extra slot)","Only appears when Regain is ON."],
  ["REVIVE","Revive (Regain extra slot)","Only appears when Regain is ON."],
  ["MASK","Mask (Regain extra slot)","Only appears when Regain is ON."]
];

function openModal(){
  renderPoolsEditor();
  modalOverlay.classList.add("show");
  modalOverlay.setAttribute("aria-hidden","false");
}
function closeModal(){
  modalOverlay.classList.remove("show");
  modalOverlay.setAttribute("aria-hidden","true");
}
function renderPoolsEditor(){
  const pools = getPools();
  modalGrid.innerHTML = "";
  for(const [key,title,hint] of POOL_FIELDS){
    const box = document.createElement("div");
    box.className = "poolBox";
    box.innerHTML = `
      <h5>${escapeHtml(title)}</h5>
      <div class="hint">${escapeHtml(hint)}</div>
      <textarea id="ta_${key}" spellcheck="false"></textarea>
    `;
    modalGrid.appendChild(box);
    box.querySelector("textarea").value = (pools[key] ?? []).join("\n");
  }
}
function saveFromEditor(){
  const next = {};
  for(const [key] of POOL_FIELDS){
    const ta = document.getElementById("ta_" + key);
    next[key] = normalizeList(ta ? ta.value : "");
  }
  savePools(next);
  showToast("Pools saved");
}
async function copyPoolsJson(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY) || JSON.stringify(getPools(), null, 2);
    await navigator.clipboard.writeText(raw);
    showToast("Copied JSON");
  }catch{
    showToast("Copy failed");
  }
}
function resetPools(){
  localStorage.removeItem(STORAGE_KEY);
  renderPoolsEditor();
  showToast("Defaults restored");
}

/* ---- Wiring ---- */
document.getElementById("rollBtn").addEventListener("click", roll);
document.getElementById("copyBtn").addEventListener("click", copyText);

document.getElementById("editPoolsBtn").addEventListener("click", openModal);
document.getElementById("closeBtn").addEventListener("click", closeModal);
document.getElementById("savePoolsBtn").addEventListener("click", ()=>{ saveFromEditor(); roll(); });
document.getElementById("resetBtn").addEventListener("click", ()=>{ resetPools(); roll(); });
document.getElementById("copyJsonBtn").addEventListener("click", copyPoolsJson);

modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });
window.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(); });

diffSlider.addEventListener("input", ()=>{
  state.difficulty = parseInt(diffSlider.value, 10) || 0;
  updateDifficultyUI();
  roll();
});

(function init(){
  updateDifficultyUI();

  const regainEl = document.getElementById("regainSwitch");
  setSwitch(regainEl, state.regain);
  regainEl.addEventListener("click", ()=>{
    state.regain = !state.regain;
    setSwitch(regainEl, state.regain);
    roll();
  });

  const attachEl = document.getElementById("attachSwitch");
  setSwitch(attachEl, state.attachments);
  attachEl.addEventListener("click", ()=>{
    state.attachments = !state.attachments;
    setSwitch(attachEl, state.attachments);
    roll();
  });

  const squadEl = document.getElementById("squadSwitch");
  setSwitch(squadEl, state.squad);
  squadEl.addEventListener("click", ()=>{
    state.squad = !state.squad;
    setSwitch(squadEl, state.squad);
    roll();
  });

  roll();
})();
</script>
</body>
</html>
